
<h2 id="toc_101">前言</h2><p>这篇教程来详细讲解如何正确的设置 AdGuard Home ，来更有效的防止 DNS 污染以及去广告。与其它 AdGuard Home 教程的只讲方法、不讲逻辑的胡乱设置不同，认真看完这篇教程你会收获大量的知识和启发。</p><h2 id="toc_102">设置</h2><h3 id="toc_103">常规设置</h3><p>文字介绍已经很好理解了，按需设置即可。重点是以下几个，如果你尚处于单身状态，那么就不要开启，否则会影响生理卫生知识的学习。</p><ul><li><strong>使用 AdGuard【家长控制】服务</strong>：如果家中有尚未成年的孩子，建议开启，屏蔽成人内容。</li><li><strong>强制安全搜索</strong>：在 Bing、Google、Yandex、YouTube 等网站上强制使用安全搜索，屏蔽 NSFW 内容。</li></ul><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021160826.png#vwid=1191&vhei=934" src="https://imgcdn.p3terx.com/post/20201021160826.png#vwid=1191&vhei=934"></figure></p><h3 id="toc_104">DNS 设置</h3><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201020032250.png#vwid=1195&vhei=602" src="https://imgcdn.p3terx.com/post/20201020032250.png#vwid=1195&vhei=602"></figure></p><h4 id="toc_105">上游 DNS 服务器</h4><p><a href="https://p3terx.com/go/aHR0cHM6Ly9rYi5hZGd1YXJkLmNvbS96aC9nZW5lcmFsL2Rucy1wcm92aWRlcnM" target="_blank" >AdGuard 文档</a>中给出了一些知名的 DNS 服务器供选择。</p><p>根据所在网络环境的不同推荐以下两组支持 ECS 功能的 DNS 服务器。如果有科学魔法爱国上网需求，你应该部署两个 AdGuard Home ，通过 DNS 分流才能达到较为理想的防污染和去广告效果。</p><ul><li><p>中国大陆网络环境推荐选择<a href="https://p3terx.com/go/aHR0cDovL3BkbnMuZG5zcG9kLmNuLw" target="_blank" >腾讯(DNSPod)</a>和<a href="https://p3terx.com/go/aHR0cHM6Ly93d3cuYWxpZG5zLmNvbS8" target="_blank" >阿里云</a>的公共 DNS 。使用它们你会惊奇的发现偶尔某些不存在的网站都是能正常解析的，只不过解析的结果并不是离你的代理服务器最近的 IP ，所以效果并不理想，而且非常不稳定。</p><blockquote><strong>TIPS:</strong> 中国大陆不推荐使用任何海外的 DNS ，因为延迟很高且都受到了不同程度的干扰，可用性不高，强行设置只会得到减速效果或者报错。</blockquote><pre><code>tls://dns.pub
https://dns.pub/dns-query
tls://dns.alidns.com
https://dns.alidns.com/dns-query</code></pre></li><li><p>国际网络环境，比如海外的 VPS 或者给科学魔法爱国上网软件做 DNS ，则推荐使用 <a href="https://p3terx.com/go/aHR0cHM6Ly9kbnMuZ29vZ2xlLw" target="_blank" >Google</a> 和 <a href="https://p3terx.com/go/aHR0cHM6Ly93d3cucXVhZDkubmV0Lw" target="_blank" >Quad9</a> 的公共 DNS。给科学魔法爱国上网软件使用的前提是它们必须在魔法名单中。</p><pre><code>tls://dns.google
https://dns.google/dns-query
tls://dns11.quad9.net
https://dns11.quad9.net/dns-query</code></pre></li></ul><p>如果你看过《<a href="https://p3terx.com/archives/use-adguard-home-to-build-dns-to-prevent-pollution-and-remove-ads-0.html" target="_blank"  target="_blank" >AdGuard Home 是什么？为什么无法去广告？</a>》那篇文章，那么你一定还记得 DoT/DoH 技术。所以这里的上游 DNS 自然是要选择 DoT/DoH 加密技术的服务器的，可以防止 DNS 解析记录被劫持、篡改以及跟踪。缺点是可能对解析速度会有些许影响，毕竟 TCP 协议不如 UDP 来得有效率，且加解密需要一点时间，不过在机器性能不错且网络通畅的情况下其实是可以忽略的，都是毫秒级别的差距。</p><p><strong>上游 DNS 服务器</strong>输入框下面有几个单选项，字面理解应该是解析策略、模式之类的选项，官方暂时没有给出详细介绍，所以博主根据字面含义和自身实际体验总结如下：</p><ul><li><strong>负载均衡</strong>：使用加权随机算法来选择最快的服务器。用到了算法，这就很玄学了。实际其实就是随机选择一个上游 DNS 服务器中的一个进行解析请求，哪个延迟低就更偏向于用哪一个。</li><li><strong>并行请求</strong>：同时请求所有上游 DNS 服务器，取最快给出的响应结果，所以解析速度很快。在上游 DNS 服务器设置合理的情况下属于万金油方案，解析速度和访问速度都很快。所以也非常适合上游 DNS 服务器连接延迟大和不稳定的情况，就比如科学魔法爱国上网使用场景。</li><li><strong>最快的 IP 地址</strong>：同时请求所有上游 DNS 服务器，在所有响应结果中选出延迟最低且可用的 IP。因为要等待所有上游 DNS 服务器响应结果，而且还要测试 IP 延迟及可用性，所以解析速度会很慢。只适合上游 DNS 服务器延迟特别低且网络非常稳定的场景，否则实际使用中可能会遇到首次打开网页非常慢，甚至可能打不开，要多刷新几次。再者低延迟 IP 不一定速度就快，还要看实际负载情况，所以这个方案的实际可用性是最差的。</li></ul><h4 id="toc_106">Bootstrap DNS 服务器</h4><p>Bootstrap DNS 服务器（引导 DNS 服务器）的作用只是解析上游 DoT/DoH 技术 DNS 服务器的域名，所以这里需要填写使用 UDP 协议的传统 DNS 服务器 IP 地址。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201020032251.png#vwid=515&vhei=268" src="https://imgcdn.p3terx.com/post/20201020032251.png#vwid=515&vhei=268"></figure></p><p>同样的这里根据网络环境的不同推荐两组：</p><ul><li><p>中国大陆</p><pre><code>119.29.29.29
119.28.28.28
223.5.5.5
223.6.6.6</code></pre></li><li><p>国际</p><pre><code>8.8.8.8
8.8.4.4
9.9.9.11
149.112.112.11</code></pre></li></ul><p>设置完点击<strong>测试上游服务器</strong>，没有问题点<strong>保存</strong>即可。</p><blockquote><strong>TIPS:</strong> 这里也可以留空，使用后面将要提到的 <strong>DNS 重写</strong>功能把 DoT/DoH DNS 服务器的域名直接指向它的 IP 是一种更优雅的使用方式。</blockquote><h4 id="toc_107">DNS 服务设定</h4><ul><li><strong>速度限制</strong>：<code>0</code></li><li><strong>使用 EDNS</strong> ：前面提及的上游 DNS 服务器都是支持 EDNS (ECS) 的，它有助于获取到更合适的 CDN 节点，建议勾选。</li><li><strong>使用 DNSSEC</strong> : 用于效验 DNS 记录的签名，防止 DNS 缓存被投毒，建议勾选。勾选后会在日志页面请求列显示小绿锁图标。</li><li><strong>禁用 IPv6</strong> ：丢弃 IPv6 的 DNS 查询。在本地网络和网站都支持 IPv6 会优先使用 IPv6 去访问网站，但目前 IPv6 的建设还处于初级阶段，大多数地区的 IPv6 网络体验都一般。还有一些代理软件对 IPv6 支持不佳，开启后可能会影响国际互联网的访问。如果对此没有特殊需求，那么直勾选即可，这样既不影响 BT 软件连接 IPv6 网络，又可以优先使用 IPv4 来上网。如果只有 IPv4 ，那么是否勾选没有区别。</li></ul><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201020032252.png#vwid=617&vhei=677" src="https://imgcdn.p3terx.com/post/20201020032252.png#vwid=617&vhei=677"></figure></p><h4 id="toc_108">DNS 缓存配置</h4><p>先简单科普一下 TTL ，它是英语 Time To Live 的简称，中文翻译为“存活时间”。放在 DNS 解析中意为一条域名解析记录在 DNS 服务器中的存留时间，单位是秒。</p><p>正常情况下 TTL 默认<code>0</code>即可，即从上游 DNS 服务器获取 TTL 值。如果你所部署的网络环境到上游 DNS 服务器的延迟比较高，那么可以适当增加 TTL 值，让缓存更持久，短时间内请求同样域名的解析会直接从缓存中读取，实现秒解析。不过 TTL 值不宜过大，不然会导致记录不能及时更新，结果是网站无法正常打开。据博主观察目前多数域名的 TTL 值普遍在 300 以内，所以给出以下设置参考值：</p><ul><li>覆盖最小 TTL 值：<code>600</code></li><li>覆盖最大 TTL 值：<code>3600</code></li></ul><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201020032253.png#vwid=473&vhei=496" src="https://imgcdn.p3terx.com/post/20201020032253.png#vwid=473&vhei=496"></figure></p><h3 id="toc_109">加密设置</h3><p>设置管理页面使用 HTTPS 加密以及 AdGuard Home 自身的 DoH/DoT 功能，如果不对外开放服务，只是在本地局域网使用是用不到的。对外开放 DNS 服务在中国大陆可能会有“法律”风险，而部署在国外网络速度缓慢，所以对于普通用户而言加密设置就成了摆设。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021160403.png#vwid=1200&vhei=935" src="https://imgcdn.p3terx.com/post/20201021160403.png#vwid=1200&vhei=935"></figure></p><h3 id="toc_110">客户端设置</h3><p>在这里可以单独设置每个设备单独使用的上游 DNS 及过滤规则，需要将设备 DNS 设置为 AdGuard Home 服务器的在 IP ，或者使用下面将要提到的 DHCP 设置。每个人的需求不一样，所以这个部分就不详细说明了。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021160404.png#vwid=1203&vhei=618" src="https://imgcdn.p3terx.com/post/20201021160404.png#vwid=1203&vhei=618"></figure></p><h3 id="toc_111">DHCP 设置</h3><p>使用 AdGuard Home 作为 DHCP 服务器去代替路由器上的 DHCP 服务器，这个功能的主要作用是自动分配 AdGuard Home 的 DNS 给到设备，然后配合<strong>客户端设置</strong>去做精细化 DNS 和过滤规则设置。除非是你的路由设备的 DHCP 功能缺斤少两，否则一般是用不到的。目前这个功能处于实验阶段，稳定性还有待考证。有兴趣的小伙伴可以自己去深入研究，这里不做过多赘述。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021160405.png#vwid=1204&vhei=758" src="https://imgcdn.p3terx.com/post/20201021160405.png#vwid=1204&vhei=758"></figure></p><h2 id="toc_112">过滤器</h2><h3 id="toc_113">DNS 封锁清单</h3><p>这里是人民群众喜闻乐见的去广告环节。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201020033102.png#vwid=1209&vhei=714" src="https://imgcdn.p3terx.com/post/20201020033102.png#vwid=1209&vhei=714"></figure></p><blockquote><strong>吐槽：</strong><code>封锁清单</code>这个词严重怀疑是机翻，而下面的绿色按钮是<code>添加阻止列表</code>。博主在查看 AdGuard Home 的源码后发现简体中文的翻译有很多不统一的地方，然后花了几个小时帮助他们改进了大量的翻译，可能在后续的版本中就不再叫<code>封锁清单</code>了。</blockquote><p>使用官方默认的 <strong>AdGuard DNS filter</strong> 规则的效果对于中国大陆的网络而言属于聊胜于无，所以需要添加一些其它的规则。然而规则并不是越多越好，多了会影解析速度，真正需要的是高质量。博主个人比较推荐 <strong>anti-AD</strong> 和 <strong>halflife</strong> 这两个规则。</p><p><details><br><summary>规则列表 | 点击查看</summary></p><table><thead><tr><th>名称</th><th>简介</th><th>地址</th></tr></thead><tbody><tr><td>AdGuard DNS Filter</td><td>AdGuard 官方维护的广告规则，涵盖多种过滤规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9hZGd1YXJkdGVhbS5naXRodWIuaW8vQWRHdWFyZFNETlNGaWx0ZXIvRmlsdGVycy9maWx0ZXIudHh0" target="_blank" >https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9hZGF3YXkub3JnLw" target="_blank" >AdAway</a></td><td>AdAway 官方的去广告 Host 规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9hZGF3YXkub3JnL2hvc3RzLnR4dA" target="_blank" >https://adaway.org/hosts.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRodWIuY29tL2JhbmJlbmRhbGFvL0FEZ2s" target="_blank" >ADgk</a></td><td>适用于 AdGuard for Android 的去广告规则，去视频 APP 广告、开屏广告</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9iYW5iZW5kYWxhby5jb2RpbmcubmV0L3AvYWRnay9kL0FEZ2svZ2l0L3Jhdy9tYXN0ZXIvQURnay50eHQ" target="_blank" >https://banbendalao.coding.net/p/adgk/d/ADgk/git/raw/master/ADgk.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRodWIuY29tL3ByaXZhY3ktcHJvdGVjdGlvbi10b29scy9hbnRpLUFE" target="_blank" >anti-AD</a></td><td>命中率高、兼容性强</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9hbnRpLWFkLm5ldC9lYXN5bGlzdC50eHQ" target="_blank" >https://anti-ad.net/easylist.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9hZGYubWluZ2dvLmV1Lm9yZy8" target="_blank" >halflife</a></td><td>涵盖了 EasyList China、EasyList Lite、CJX 's Annoyance、乘风视频过滤规则，以及补充的其它规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL28wSGFsZkxpZmUwby9saXN0QG1hc3Rlci9hZC50eHQ" target="_blank" >https://cdn.jsdelivr.net/gh/o0HalfLife0o/list@master/ad.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC50by8" target="_blank" >EasyList</a></td><td>Adblock Plus 官方维护的广告规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC1kb3dubG9hZHMuYWRibG9ja3BsdXMub3JnL2Vhc3lsaXN0LnR4dA" target="_blank" >https://easylist-downloads.adblockplus.org/easylist.txt</a></td></tr><tr><td>EasyList China</td><td>面向中文用户的 EasyList 去广告规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC1kb3dubG9hZHMuYWRibG9ja3BsdXMub3JnL2Vhc3lsaXN0Y2hpbmEudHh0" target="_blank" >https://easylist-downloads.adblockplus.org/easylistchina.txt</a></td></tr><tr><td>EasyPrivacy</td><td>反隐私跟踪、挖矿规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC1kb3dubG9hZHMuYWRibG9ja3BsdXMub3JnL2Vhc3lwcml2YWN5LnR4dA" target="_blank" >https://easylist-downloads.adblockplus.org/easyprivacy.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRlZS5jb20veGluZ2dzZi9BZGJsb2NrLVJ1bGUv" target="_blank" >Xinggsf 乘风通用</a></td><td>国内网站广告过滤规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRlZS5jb20veGluZ2dzZi9BZGJsb2NrLVJ1bGUvcmF3L21hc3Rlci9ydWxlLnR4dA" target="_blank" >https://gitee.com/xinggsf/Adblock-Rule/raw/master/rule.txt</a></td></tr><tr><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRlZS5jb20veGluZ2dzZi9BZGJsb2NrLVJ1bGUv" target="_blank" >Xinggsf 乘风视频</a></td><td>视频网站广告过滤规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9naXRlZS5jb20veGluZ2dzZi9BZGJsb2NrLVJ1bGUvcmF3L21hc3Rlci9tdi50eHQ" target="_blank" >https://gitee.com/xinggsf/Adblock-Rule/raw/master/mv.txt</a></td></tr><tr><td>MalwareDomainList</td><td>恶意软件过滤规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly93d3cubWFsd2FyZWRvbWFpbmxpc3QuY29tL2hvc3RzbGlzdC9ob3N0cy50eHQ" target="_blank" >https://www.malwaredomainlist.com/hostslist/hosts.txt</a></td></tr><tr><td>Adblock Warning Removal List</td><td>去除禁止广告拦截提示规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC1kb3dubG9hZHMuYWRibG9ja3BsdXMub3JnL2FudGlhZGJsb2NrZmlsdGVycy50eHQ" target="_blank" >https://easylist-downloads.adblockplus.org/antiadblockfilters.txt</a></td></tr><tr><td>Fanboy's Annoyances List</td><td>去除页面弹窗广告规则</td><td><a href="https://p3terx.com/go/aHR0cHM6Ly9lYXN5bGlzdC1kb3dubG9hZHMuYWRibG9ja3BsdXMub3JnL2ZhbmJveS1hbm5veWFuY2UudHh0" target="_blank" >https://easylist-downloads.adblockplus.org/fanboy-annoyance.txt</a></td></tr></tbody></table><p></details></p><h3 id="toc_114">DNS 允许清单</h3><p>在这里你可以设置排除封锁清单中的被屏蔽的域名。比如做淘宝客、广告联盟之类的人群可能会用得到，毕竟封锁清单基本涵盖了他们的业务范围。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021161521.png#vwid=1192&vhei=682" src="https://imgcdn.p3terx.com/post/20201021161521.png#vwid=1192&vhei=682"></figure></p><h3 id="toc_115">DNS 重写</h3><p>在这里你可以方便的把一个域名指向一个 IP ，简单来说这个功能相当于 hosts 。</p><p>最典型的一个使用场景是把 DoH/DoT DNS 服务器的域名直接指向它们的 IP ，这样就不再需要进行我查我自己这样浪费时间的迷惑操作了，可进一步加快解析的速度。一般来说 DoT/DoH DNS 服务器的 IP 是固定的，而且 IP 地址和它们自家的传统 DNS 服务器的 IP 是一致的。这里需要注意的是处在公测阶段的 DNSPod 是个例外(<del>难怪腾讯云做不过阿里云，这种细节上的东西很能体现出是否专业</del>)。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20210423045545.png#vwid=1211&vhei=673" src="https://imgcdn.p3terx.com/post/20210423045545.png#vwid=1211&vhei=673"></figure></p><h3 id="toc_116">已阻止服务</h3><p>在这里你可以一键禁止访问一些热门网站和服务，比如 Facebook 、Twitter 。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021161524.png#vwid=1193&vhei=750" src="https://imgcdn.p3terx.com/post/20201021161524.png#vwid=1193&vhei=750"></figure></p><h3 id="toc_117">自定义过滤规则</h3><p>在这里你可以自定义符合 adblock 语法或 Hosts 语法的规则，以及检查过滤域名是否被过滤。具体如何使用可以参考页面上的示例和官方文档。</p><p><figure><img class="" alt="" data-src="https://imgcdn.p3terx.com/post/20201021161523.png#vwid=1190&vhei=877" src="https://imgcdn.p3terx.com/post/20201021161523.png#vwid=1190&vhei=877"></figure></p><h2 id="toc_118">尾巴</h2><p>到这里 AdGuard Home 的设置就算是介绍完了，有简体中文，而且 UI 逻辑很清晰，很容易上手。</p><h2 id="toc_119">AdGuard Home 系列</h2><ul><li>《<a href="https://p3terx.com/archives/use-adguard-home-to-build-dns-to-prevent-pollution-and-remove-ads-0.html" target="_blank"  target="_blank" >AdGuard Home 是什么？为什么无法去广告？</a>》</li><li>《<a href="https://p3terx.com/archives/use-adguard-home-to-build-dns-to-prevent-pollution-and-remove-ads-1.html" target="_blank" >AdGuard Home 自建 DNS 防污染、去广告教程 #1 - 安装部署(Docker)</a>》</li><li>《<a href="https://p3terx.com/archives/use-adguard-home-to-build-dns-to-prevent-pollution-and-remove-ads-2.html" target="_blank" >AdGuard Home 自建 DNS 防污染、去广告教程 #2 - 优化增强设置详解</a>》</li></ul><hr><p>本博客已开设 <a href="https://p3terx.com/go/aHR0cHM6Ly90Lm1lL1AzVEVSWF9aT05F" target="_blank" >Telegram 频道</a>，欢迎小伙伴们订阅关注。</p>
