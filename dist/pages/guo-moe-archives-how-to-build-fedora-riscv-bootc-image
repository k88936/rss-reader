<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-225353b64e60809ca975d6b65db48a21"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-225353b64e608051aff9eb0b0b900f67" data-id="225353b64e608051aff9eb0b0b900f67"><span><div id="225353b64e608051aff9eb0b0b900f67" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e608051aff9eb0b0b900f67" title="🤔 我的目标是什么"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">🤔 我的目标是什么</span></span></h2><div class="notion-text notion-block-225353b64e6080bc85c5cb364437e589">第一步不应该直接构建 RISC-V 架构的 bootc 镜像，首先我们起码要确保能构建一个 x86_64 的镜像，然后再去想 riscv64 的事；然后，我们要构建一个能够从 QEMU 启动的镜像。</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-225353b64e6080a484d2cb05c0ac5ae7" data-id="225353b64e6080a484d2cb05c0ac5ae7"><span><div id="225353b64e6080a484d2cb05c0ac5ae7" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080a484d2cb05c0ac5ae7" title="📝 构建镜像！"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">📝 构建镜像！</span></span></h2><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-225353b64e6080c6b895dc86de7fa8c2" data-id="225353b64e6080c6b895dc86de7fa8c2"><span><div id="225353b64e6080c6b895dc86de7fa8c2" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080c6b895dc86de7fa8c2" title="x86_64"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">x86_64</span></span></h3><div class="notion-text notion-block-225353b64e60801a8c5ce533f328ef49">先看看 x86_64 是怎么做的。我们可以参考一下这个文档：<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://docs.fedoraproject.org/en-US/bootc/base-images/">https://docs.fedoraproject.org/en-US/bootc/base-images/</a></div><div class="notion-text notion-block-225353b64e6080168f09c9dd746917d9">根据文档，我们可以了解到构建过程有以下几步：</div><ul class="notion-list notion-list-disc notion-block-225353b64e608076add0c6d1579d63f8"><li>构建一个 bootc 的 Container 镜像</li></ul><ul class="notion-list notion-list-disc notion-block-225353b64e6080589821c663f6e36770"><li>使用这个 Container 镜像来生成 QEMU 镜像</li></ul><ul class="notion-list notion-list-disc notion-block-225353b64e6080c89605e0b9a7a6489e"><li>启动</li></ul><div class="notion-text notion-block-225353b64e6080a2b1d0ef3b58c6ef32">首先是第一步，我们应该怎么构建一个 bootc 的 Container 镜像？根据文档，我们要用 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://gitlab.com/fedora/bootc/base-images">https://gitlab.com/fedora/bootc/base-images</a> 这个仓库内的内容，生成 bootc 的 container 镜像，然后使用 <!-- --> 运行</div><div class="notion-text notion-block-225353b64e6080f19f54f46a59b18f45">嗯，看起来还是挺简单的，一共就两个要使用到的仓库。</div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-225353b64e6080199d0ccea0255ab015" data-id="225353b64e6080199d0ccea0255ab015"><span><div id="225353b64e6080199d0ccea0255ab015" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080199d0ccea0255ab015" title="riscv64"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">riscv64</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-225353b64e60808f9fe5d5cf0f755f92" data-id="225353b64e60808f9fe5d5cf0f755f92"><span><div id="225353b64e60808f9fe5d5cf0f755f92" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e60808f9fe5d5cf0f755f92" title="构建 bootc container image"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">构建 bootc container image</span></span></h4><div class="notion-text notion-block-225353b64e60804eb7e8dffe27272db9">所以首先，我们应该先构建一个 bootc 的 Container 镜像，我们这里 fork gitlab的仓库，然后进行修改，fork 后的仓库地址在这：</div><div class="notion-text notion-block-225353b64e60806087ccc53305ef191a">主要的修改内容是：将 Containerfile 中原本的 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://quay.io/fedora/fedora:rawhide">quay.io/fedora/fedora:rawhide</a> 替换为 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://docker.io/fedorariscv/base:42">docker.io/fedorariscv/base:42</a> ，并且将 fedora.repo 中的仓库更改为我们自己编译后的 fedora riscv 仓库，内容为</div><div class="notion-text notion-block-225353b64e6080ee8cece4c9aa4fc15b">然后在 Fedora RISC-V 42 QEMU System mode 环境下运行（注意，这里不能跨架构运行，也就是不能用 qemu usermode 来直接模拟，具体原因还没分析）</div><div class="notion-text notion-block-225353b64e6080dbb0edd4f306daf7f1">即可。</div><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-225353b64e6080268ce7e97902650b3a" data-id="225353b64e6080268ce7e97902650b3a"><span><div id="225353b64e6080268ce7e97902650b3a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080268ce7e97902650b3a" title="构建 QEMU 镜像"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">构建 QEMU 镜像</span></span></h4><div class="notion-text notion-block-225353b64e6080e8b20cf01c50f5f60a">我们还需要修改 bootc-image-builder 来让它工作，修改后可成功生成的修改已经放到仓库 <!-- --> 上了。</div><div class="notion-text notion-block-225353b64e60805782bbd93a1350319b">具体而言，就是添加架构所使用的分区，修改 Containerfile 使其使用 fedorariscv/base ，同样地，它目前也无法跨架构，具体的pr内容见 <!-- --> </div><div class="notion-text notion-block-225353b64e6080fdaefeea5c820eb290">使用该仓库内容进行 <code class="notion-inline-code">podman build -t </code><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="http://docker.io/fedorariscv/bootc-image-builder:latest">docker.io/fedorariscv/bootc-image-builder:latest</a></code> 以后，运行 </div><div class="notion-text notion-block-225353b64e60806a8681eb7d83300733">会生成一个 .raw 的 image。注意，由于目前 bootupd 的版本号尚未更新，即使它已经支持 riscv 架构，它还没被合并到 Fedora 官方，等下次版本号更新就能解决了。所以目前，镜像还需要自己放 grubriscv64.efi 、grub.cfg 和 startup.nsh ，这几个文件都可以从目前已有的 QEMU minimal 镜像搬来。</div><div class="notion-text notion-block-225353b64e6080da95a8c8d16d8dacf6">生成的镜像使用以下命令开机</div><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-225353b64e6080dc84b0ddbed1f3ad0a" data-id="225353b64e6080dc84b0ddbed1f3ad0a"><span><div id="225353b64e6080dc84b0ddbed1f3ad0a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080dc84b0ddbed1f3ad0a" title="构建适用于 7700 的镜像"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">构建适用于 7700 的镜像</span></span></h4><div class="notion-text notion-block-225353b64e6080699de0d7564035dfcf">7700 的镜像需要使用它们的内核(内核可以通过这种方式生成：<!-- -->)，并且最好用上它们的固件，编写一个 Containerfile ，然后写下以下内容</div><div class="notion-text notion-block-225353b64e608068abcaf9495fc3c9c4">构建好后，使用以下命令生成</div><div class="notion-text notion-block-225353b64e608027aeeaf0ff2d7d208f">同样地，也要从正常的minimal镜像搬grub，7700的镜像还需要在 <code class="notion-inline-code">/boot/efi</code> 添加以下内容</div><div class="notion-text notion-block-225353b64e608076a8e9f59d969ba456">然后在 /boot/loader/entries 处，删掉 console=tty0 和 console=ttyS0 ，并将 dtb 文件夹从 ostree 文件夹复制至 /boot 文件夹。</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-225353b64e6080db95e3f62e77bd8a74" data-id="225353b64e6080db95e3f62e77bd8a74"><span><div id="225353b64e6080db95e3f62e77bd8a74" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e6080db95e3f62e77bd8a74" title="🤗 使用"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">🤗 使用</span></span></h2><div class="notion-text notion-block-225353b64e60807c95e2f9b318c2518f">在这个里面，根目录被挂载为 readonly ，实际上挂载最后一个分区会发现，这个分区和传统的 rootfs 并不相通，里面只有两个叫 <code class="notion-inline-code">ostree</code> 和 <code class="notion-inline-code">boot</code> 的文件夹。要安装软件，也是要通过 rpm-ostree install 来安装，然后它会重新生成一个新的 layer(?) ，下次启动的时候就跟从这个 layer 启动。</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-225353b64e60801d8d23c5cb450c662c" data-id="225353b64e60801d8d23c5cb450c662c"><span><div id="225353b64e60801d8d23c5cb450c662c" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e60801d8d23c5cb450c662c" title="🧐 已知问题"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">🧐 已知问题</span></span></h2><ul class="notion-list notion-list-disc notion-block-225353b64e608071b25de285d9580f5a"><li>目前 bootupd 无法生成 grub 配置文件</li></ul><ul class="notion-list notion-list-disc notion-block-225353b64e6080e2abf2c9d1cf92ebdf"><li>目前 ESWin EIC7700 设备无法支持 16G 版本（bootc仅支持grub且未来不会支持extlinux）</li></ul><ul class="notion-list notion-list-disc notion-block-225353b64e60805ebc67e458e0c8564b"><li>目前 ESWin EIC7700 的内核无法安装软件，表现形式为：使用 rpm-ostree install fastfetch 的时候会出现 error: Executing %transfiletriggerin for glibc-common: Creating bwrap instance</li></ul><div class="notion-blank notion-block-225353b64e60802cbc4dff2d4b4d38b5"> </div><div class="notion-blank notion-block-225353b64e608082bfa1d125783b8d96"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-225353b64e608071a1f7c8072163e77c" data-id="225353b64e608071a1f7c8072163e77c"><span><div id="225353b64e608071a1f7c8072163e77c" class="notion-header-anchor"></div><a class="notion-hash-link" href="#225353b64e608071a1f7c8072163e77c" title="😇 体验链接"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">😇 体验链接</span></span></h2><div class="notion-text notion-block-225353b64e6080be8364e51a4435dcb5">已经制作出来的镜像可以在 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://images.fedoravforce.org/">https://images.fedoravforce.org/</a> 处下载：</div><div class="notion-text notion-block-225353b64e6080e0a635fd8b03bfe282">ESWin 7700: <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://images.fedoravforce.org/EIC7700-EVB">https://images.fedoravforce.org/EIC7700-EVB</a></div><div class="notion-text notion-block-225353b64e6080b2b8c5d3eb40cbe7c4">QEMU：<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://images.fedoravforce.org/QEMU">https://images.fedoravforce.org/QEMU</a></div></main></div>