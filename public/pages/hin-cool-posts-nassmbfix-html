<h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><p>今天我打开某网站，选择上传文件后当前网页和浏览器就无法点击了，用<code>ctrl+w</code>测试了好几次都如此。打开电脑的资源管理器，瞥见我通过 smb 添加的 nas 连接已经断开，点击则提示“本地设备名已在使用中 此连接尚未还原”。</p><p>于是我猜测可能是昨天上传文件选择的是 nas 中的一个目录，现在无法访问 nas，导致网页和浏览器假死。删除该映射后，再尝试添加，搜索不到局域网共享的设备了。</p><p><img src="https://cdn2.hin.cool/pic/sc/nassmbfind.jpg" alt="找不到nas了"></p><h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><p>在必应一搜，有各种不同的解决办法。Windows 的共享服务开着，启用网络发现正常，重启<code>LanmanWorkstation</code>不行，重启电脑也不行，于是我打开了 deepseek。</p><blockquote><p>”本地设备名已在使用当中”通常意味着：</p><ol><li>Windows尝试用一个你已经用过的名称（比如<code>\\NAS</code>）去建立连接，但之前的连接会话因为某种原因没有完全释放，导致冲突。</li><li>Windows的网络发现功能暂时失灵，无法正确找到网络上的设备。</li></ol><p>“搜索不到NAS了”则说明问题可能更偏向于网络发现层面。</p></blockquote><h3 id="PING"><a href="#PING" class="headerlink" title="PING"></a>PING</h3><p>在 AI 的建议下，我尝试<code>ping</code> 我的 nas。</p><p>结论：直接<code>ping</code> nas 的局域网 IP 没有丢包，并且在 Windows 资源管理器中通过 IP 地址添加映射可以正常连接到 nas。</p><p><code>ping</code> nas 的“局域网名称即 mynas 或 mynas.lan”（mDNS）则显示：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\LonelyGod&gt;ping lonelygodnas.lan</span><br><span class="line">正在 Ping mynas.lan [240e:330:96f6:****::26d] 具有 32 字节的数据:</span><br><span class="line">无法访问目标主机。</span><br><span class="line">无法访问目标主机。</span><br><span class="line">无法访问目标主机。</span><br><span class="line">无法访问目标主机。</span><br><span class="line"></span><br><span class="line">240e:330:96f6:****::26d 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 = 4，已接收 = 0，丢失 = 4 (100% 丢失)</span><br></pre></td></tr></table></figure><p>这就很令人迷惑了，为什么使用<code>ping</code>和<code>nslookup</code>默认解析的是 IPv6 地址呢？</p><h3 id="MTU？"><a href="#MTU？" class="headerlink" title="MTU？"></a>MTU？</h3><p>我使用 ipv6 测试网站进行测试，发现有一个前所未有的报错，但手机测试没有该报错：</p><p><img src="https://cdn2.hin.cool/pic/sc/nassmbipv6test.jpg/sy" alt="测试显示你的 IPv6 可能存在 MTU 问题，这会导致 IPv6 网站加载缓慢（或失败）"></p><p>于是我以为真的是电脑上的 MTU 问题，AI 也给出了可能的原因，比如代理软件或游戏加速器可能会修改 TCP/IP 参数，包括 MTU。</p><p>为了确认电脑上是否存在 MTU 有无问题，我尝试 <code>ping -6 -l 1500 test6.ustc.edu.cn</code>，即强制使用 IPv6，发送 1500 字节的数据包并且不分段去 <code>ping</code>一个纯 IPv6 的链接，结果丢包率为 20%。将数据包改成宽带 IPv4 默认的 1492 后，丢包率为 0。</p><p><img src="https://cdn2.hin.cool/pic/sc/nassmbmtutest.jpg/sy" alt="测试IPv6不同数据包大小的连通率"></p><h3 id="mDNS缓存？"><a href="#mDNS缓存？" class="headerlink" title="mDNS缓存？"></a>mDNS缓存？</h3><p>正当我以为就是 MTU 配置的问题时，我又查看了一下<code>ping</code>我的 nas 时并非是连接超时，而是无法访问目标主机啊！</p><p>于是我登陆 nas 查看网卡的 IPv6 地址，发现和电脑上解析的地址并不一致。</p><p>我使用<code>ipconfig /flushdns</code>清除缓存，没用，因为这玩意只是清除传统的 DNS 缓存。但对mDNS（<code>.local</code>、<code>.lan</code>域名的解析）缓存无效。</p><p>根据 AI 的建议，使用<code>net stop &quot;DNS Client&quot;</code>无效，提示：这项服务无法接受请求的“暂停”、“继续”或“停止”操作。</p><p>使用<code>nbtstat -R</code>无效，显示 NBT 远程缓存名称表的成功清除和预加载。但电脑解析到的 IPv6 地址依然没变。</p><p>使用<code>netsh interface ipv6 reset</code>无效。</p><h3 id="IPv6-的有状态和无状态"><a href="#IPv6-的有状态和无状态" class="headerlink" title="IPv6 的有状态和无状态"></a>IPv6 的有状态和无状态</h3><p>我查看路由器上给设备分配的 DHCPv6 租约，确实就是<code>240e:330:96fc:****::26d/128</code>呀，说明电脑获取到的 IPv6 并非缓存。nas 中只有一个 SLAAC 无状态地址，路由器作为上级 DNS 给电脑的却是 DHCPv6 有状态地址——但是 nas 没有使用这个有状态地址。</p><p>这真是一个令人头大的问题，以前折腾家里的 H3C 路由器时就为有状态和无状态、路由通告等折磨得不行。</p><p>AI 给出的解决办法之一便是禁用 DHCPv6，仅使用 SLAAC。考虑到此前我在路由器上绑定了群晖 DDNS 解析的域名劫持为本地的 IPv4 地址，虽然发现无法正常连接 nas 的 smb 后，我又删除了该劫持，但是没有重启路由器。</p><p>重启路由器之后，路由器端显示了给 nas 的 DHCPv6 租约，nas 里也有了这个无状态地址，Windows 资源管理器中也能找到 nas 的映射服务了。</p><p><img src="https://cdn2.hin.cool/pic/sc/nassmbfind2.jpg/sy" alt="可以找到nas了"></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看来确实是我不该添加域名劫持？不！我不服气！添加劫持的是一个公网域名，而不是 mDNS 提供的私网域名（nas.lan），凭什么影响到私网呢？</p><p>为此，我又一次添加了该劫持，在浏览器控制台里看到劫持没有生效，重启路由器后，在控制台可以看到，在局域网访问该公网域名确实会解析到内网 IP 地址了。</p><p>点开 Windows 资源管理，尝试添加 nas 的共享网络文件夹，没问题！说明确实不是域名劫持的问题。</p><p>但是！即便 nas 的网卡里有路由器分配的有状态地址，局域网内通过浏览器访问该地址也是超时，而<code>ping</code>和 SMB 映射却没有任何问题。</p><p>所以这次故障仅仅只是路由器固件的一个 bug 吗？</p>