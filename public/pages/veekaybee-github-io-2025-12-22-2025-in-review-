<p><figure><img src="https://veekaybee.github.io/images/girl_with_candle.jpg" width="400">
</figure>

<em>Jeune fille lisant une lettre √† la bougie, Jean-Baptiste Santerre, 1700</em></p>
<p>Machine learning engineers spend their lives alternating between two states: staring at <a href="https://tqdm.github.io/">tqdm progress bars</a> during model training and staring at error logs during model inference.</p>
<p>A third category now involves staring at coding agent CLI progress bars, but using too much AI assistance during coding makes me feel like I&rsquo;m losing <a href="https://vickiboykis.com/2023/09/13/build-and-keep-your-context-window/">my own context window</a>.</p>
<p>I started a new job as a founding MLE in March and, as is true for engineers in any small and young team, I‚Äôve been staring at error logs all across the stack.</p>
<p>The good news is that if you are at a point where you care a lot about error logs, it means you have users who care a lot about the answer to &ldquo;What if this breaks?&rdquo; If you have people other than you who care about your software, congratulations, <a href="https://vickiboykis.com/2021/06/20/the-ritual-of-the-deploy/">you are in production</a>. Being in the state of production is the best possible outcome for software engineers because it means the work we‚Äôre doing is useful.</p>
<p>Standing up a new thing in production, though, is scary, because production means you are responsible - to the end-user, to the other developers on your team, and, finally, to yourself.</p>
<p>In &ldquo;The Tombs of Atuan&rdquo;, Ursula K. Le Guin writes of a girl, Tenar, who is taken at a very young age from her family and goes to live in a holy city. In a ritual ceremony, her name is changed and she loses her identity to become Arha, the Eaten One. Arha is the High Priestess of the Place of the Tombs, a vast series of caverns under the earth, silent, and in complete darkness, ‚Äúfull of gold and the swords of old heroes, and old crowns, and bones, and years, and silence.‚Äù</p>
<p>In her first trip to the tombs with an elder priestess, they descend into the dark without a torch.</p>
<blockquote>
<p>‚ÄúLight is forbidden here.‚Äù Kossil‚Äôs whisper was sharp. Even as she said it, Arha knew it must be so. This was the very home of darkness, the inmost center of the night. Three times her fingers swept across a gap in the complex, rocky blackness. The fourth time she felt for the height and width of the opening, and entered it. Kossil came behind. In this tunnel, which went upward again at a slight slant, they passed an opening on the left, and then at a branching way took the right: all by feel, by groping, in the blindness of the underearth and the silence inside the ground. In such a passageway as this, one must reach out almost constantly to touch both sides of the tunnel, lest one of the openings that must be counted be missed, or the forking of the way go unnoticed.</p>
</blockquote>
<p>This is what building a new production system is like. You go into it, like Arha, scared, groping entirely in the darkness.</p>
<p>If you need a cache, you can use a <a href="https://go.dev/blog/swisstable">Go map</a>, lru cache, or Redis. If you need a vector store, you can use <code>np.array</code>, or Postgres, or Pinecone/Chroma/Turbopuffer/ or Elasticsearch. You could run your whole stack on Docker Compose, or a single bare-metal server in your basement, or Kubernetes in the cloud, or <a href="https://bogdanthegeek.github.io/blog/projects/vapeserver/">on a vape.</a></p>
<p>Forget large-scale architecture choices.
How will <a href="https://vickiboykis.com/2023/06/29/naming-things/">you name things</a>? Should you name your method <code>get_results</code> or <code>get_query_results</code>? Will you ever get results that are more than just the answer to a query? Will you ever use this method in a more abstract way? Does it need to be part of a class? What exceptions should you write for it? We want to write <a href="https://npf.io/2017/08/lies/">code that must never lie</a>, but what if, at the time, we are telling the truth to ourselves?</p>
<p>How soon do we need to ship <code>get_query_results</code>? How many other methods will rely on it? How many of our teammates need this method for their work as well? Will they understand it? Code is meant, largely still and hopefully for the forseeable future, for humans to read first and machines to compile second.</p>
<p>In &ldquo;The Bell Jar&rdquo;, Sylvia Plath laments about the endless myriad combinations of a possible life, &ldquo;I saw my life branching out before me like the green fig tree in the story. From the tip of every branch, like a fat purple fig, a wonderful future beckoned and winked.&rdquo; By the time she&rsquo;s done thinking through all these futures,she hasn&rsquo;t made a decision, and they all slip away from her.</p>
<p>The forking branches of a decision tree in a codebase, are likewise boundless, and the neat part is that there is no right answer. You are constrained by your business requirements, but the choice of implementation of those requirements is of an endless variety. It will depend on: the stack you already have, the budget for the rest of the stack, your <a href="https://vickiboykis.com/2024/12/16/write-code-with-your-alphabet-radio-on/">own past experience and engineering values</a>, the social norms and expectations of your team and their collective experience, the industry&rsquo;s vocabulary, the language you&rsquo;re writing in, its conventions and affordances, and how much time you have to actually think about, finish, and merge this current PR before you need to deploy. That&rsquo;s why staff engineers make money mostly by saying &ldquo;it depends&rdquo; for years on end in different ways.</p>
<p>Let&rsquo;s say your goal is to build a scalable, distributed, microservice architecture that processes inputs and streams machine learning inference outputs to users with minimal downtime, and that the system is resilient to failures via container orchestration. I&rsquo;ve just described every machine learning systems since the beginning of time, this is the machine learning system they show you in Plato&rsquo;s ML engineering cave, in every single Medium post on the planet, this is the set of boxes connected by dotted lines that arrives to unbidden to every engineer in their dreams. This is the light at the end of your labyrinth.</p>
<p>But, in building such a system, you never start by building such a system. You have to start with a single keystroke in the inky blackness.This is one of the reasons it&rsquo;s so hard to write code with LLMs and evaluate their output, by the way: humans reason from the inside out - <a href="https://www.dwarkesh.com/p/andrej-karpathy">&ldquo;When you write this code, you don‚Äôt go from top to bottom, you go from chunks and you grow the chunks&hellip;&rdquo;</a> - and LLMs write code from top down.</p>
<p>So, instead, you take a deep breath and write a single method to tokenize a string.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tokenize</span>(string:str) <span style="color:#f92672">-&gt;</span> list[str]:
</span></span><span style="display:flex;"><span> tokens <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> tokens
</span></span></code></pre></div><p>Tokenizing a string is the process of splitting it into subsections and converting each of them into a number so they can be processed by a <a href="https://huggingface.co/learn/llm-course/en/chapter2/4">transformer-style model</a>. Tokenization is not specific to LLMs. We&rsquo;ve been doing tokenization for a long time. <a href="https://aclanthology.org/C92-4173.pdf">Here&rsquo;s a paper on how important it is for preprocessing from 1992!</a></p>
<p>The first part of tokenizing any text is splitting it into those sub-parts. Those sub-parts can be words, syllables, or characters. We start with words to make it easier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sentence <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The truest power is the power to choose. - Ursula K. Le Guin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tokenize</span>(string:str) <span style="color:#f92672">-&gt;</span> list[str]:
</span></span><span style="display:flex;"><span> tokens <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> tokens
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(tokenize(sentence))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;The&#39;</span>, <span style="color:#e6db74">&#39;truest&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;is&#39;</span>, <span style="color:#e6db74">&#39;the&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;to&#39;</span>, <span style="color:#e6db74">&#39;choose.&#39;</span>, <span style="color:#e6db74">&#39;-&#39;</span>, <span style="color:#e6db74">&#39;Ursula&#39;</span>, <span style="color:#e6db74">&#39;K.&#39;</span>, <span style="color:#e6db74">&#39;Le Guin&#39;</span>]
</span></span></code></pre></div><p>Easy, and we have something concrete. Do we count &ldquo;K.&rdquo; as a word? How about the punctuation, do we generally want to include that for tokenization in a transformer-style model?</p>
<p>What do we do with input text that has numbers in it? Do we include them or strip them out?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sentence <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The truest 1 power is the power to choose. - Ursula K. Le Guin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(tokenize(sentence))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;The&#39;</span>, <span style="color:#e6db74">&#39;truest&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;is&#39;</span>, <span style="color:#e6db74">&#39;the&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;to&#39;</span>, <span style="color:#e6db74">&#39;choose&#39;</span>, <span style="color:#e6db74">&#39;Ursula&#39;</span>, <span style="color:#e6db74">&#39;K.&#39;</span>, <span style="color:#e6db74">&#39;Le Guin&#39;</span>]
</span></span></code></pre></div><p>What happens when we instead get malformed inputs from a webpage, or if we have delimiters?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sentence <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The&amp;lt;html&gt;truest</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">power</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">is</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">the</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">power</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">to</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">choose</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Ursula</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">K</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Le</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Guin&#34;</span>
</span></span><span style="display:flex;"><span>print(tokenize(sentence))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;The&amp;lt;html&gt;truest&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;is&#39;</span>, <span style="color:#e6db74">&#39;the&#39;</span>, <span style="color:#e6db74">&#39;power&#39;</span>, <span style="color:#e6db74">&#39;to&#39;</span>, <span style="color:#e6db74">&#39;choose&#39;</span>, <span style="color:#e6db74">&#39;Ursula&#39;</span>, <span style="color:#e6db74">&#39;K.&#39;</span>, <span style="color:#e6db74">&#39;Le&#39;</span>, <span style="color:#e6db74">&#39;Guin&#39;</span>]
</span></span></code></pre></div><p>What if the input is an empty string? Do we want to send that empty string downstream?</p>
<p>What if we don‚Äôt have a string to tokenize? We now get an exception that we have to think about how to handle if we&rsquo;re in production.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>string <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>tokenize(sentence)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Traceback (most recent call last):
</span></span><span style="display:flex;"><span> File <span style="color:#e6db74">&#34;/Users/vicki/arha/tokenize.py&#34;</span>, line <span style="color:#ae81ff">9</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&amp;</span>lt; module<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> print(tokenize(sentence))
</span></span><span style="display:flex;"><span> File <span style="color:#e6db74">&#34;/Users/vicki/arha/tokenize.py&#34;</span>, line <span style="color:#ae81ff">5</span>, <span style="color:#f92672">in</span> tokenize
</span></span><span style="display:flex;"><span> tokens <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AttributeError</span>: <span style="color:#e6db74">&#39;NoneType&#39;</span> object has no attribute <span style="color:#e6db74">&#39;split&#39;</span>
</span></span></code></pre></div><p>What if we receive emojis? This string representation returns only one token, which may not be correct in representing these two different emotions. And how do we know the model accepts emoji codepoints as input anyway? Many GPT-style models do, but many <a href="https://github.com/huggingface/transformers/issues/7648">BERT models don&rsquo;t</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sentence <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ü§™ü•∞&#34;</span>
</span></span><span style="display:flex;"><span>print(tokenize(sentence))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;ü§™ü•∞&#39;</span>]
</span></span></code></pre></div><p>What if we send an extremely large string because we don&rsquo;t have upstream error handling for our tokenization queries? This code block will take a long time to return because you are creating a large object in memory. Since we don&rsquo;t have logging yet, we won&rsquo;t know in the rest of our application where that large object creation takes place. We will just have a web service that hangs silently, indefinitely.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_tokens <span style="color:#f92672">=</span> <span style="color:#ae81ff">500_000_000</span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;The truest power is the power to choose. - Ursula K. Le Guin&#34;</span>
</span></span><span style="display:flex;"><span>large_string <span style="color:#f92672">=</span> pattern <span style="color:#f92672">*</span> num_tokens
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(tokenize(large_string))
</span></span><span style="display:flex;"><span>hanging forever<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>What if our input includes languages other than English? How do we account for <a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">Unicode</a>?</p>
<p>Sometimes, you&rsquo;re able to come up with most of these edge cases at once. Mostly, though, you end up building out these edge cases over countless iterations, because software engineering is <a href="https://adamj.eu/tech/2021/11/03/software-engineering-is-programming-integrated-over-time/">programming integrated over time.</a></p>
<p>Eventually, you build up to a codebase that has a <a href="https://github.com/openai/tiktoken/blob/97e49cbadd500b5cc9dbb51a486f0b42e6701bee/src/lib.rs#L97">level of thought and care</a> around tokenization, punctuation, and input sanitization. You&rsquo;ve now written a codebase at the level of <a href="https://github.com/huggingface/tokenizers/tree/main">tokenizers</a>, or <a href="https://spacy.io/api/tokenizer">spacy</a> or <a href="https://github.com/openai/tiktoken">tiktoken</a>.</p>
<p>In fact, you should probably use the libraries that people have already put collectively dozens of combined years of thought into - those corridors are closed, safe, and tested, in the case of open-source libraries, by a much larger community than just you. You import <code>tokenizers</code>.</p>
<p>In doing so, you close off a number of paths further into the labyrinth behind you, the doors darkened and abandoned. You light a single flickering torch to mark your path. On top of that code, you start adding the things that make that path more resilient (but also, then harder to refactor if you decide to pivot): precise exception handling, traces, clear <a href="https://vickiboykis.com/2025/07/16/my-favorite-use-case-for-ai-is-writing-logs/">human-legible logging</a>, and unit tests. A single corridor in your application starts to shine. With the path in front fo you illuminated, you move forward.</p>
<p>Now that tokenization works, since you need this method throughout your application, you&rsquo;ll want to create a tokenizer inference service.</p>
<p>Within the logic itself, if you&rsquo;re using an external tokenizer, you&rsquo;ll need to make sure it matches the model you&rsquo;re using, because the model depends on a given tokenization scheme, In this case, we are better off relying on <a href="https://huggingface.co/docs/transformers/en/model_doc/auto">AutoTokenizer</a>, which handles the import and comparison logic for us:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> transformers <span style="color:#f92672">import</span> AutoTokenizer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name_or_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;arha-based-uncased&#34;</span>
</span></span><span style="display:flex;"><span>tokenizer <span style="color:#f92672">=</span> AutoTokenizer<span style="color:#f92672">.</span>from_pretrained(name_or_path)
</span></span></code></pre></div><p>If you are downloading the tokenizer from HuggingFace, as <code>AutoTokenizer</code> does unless you specify a custom tokenizer path, you add a network call and an external dependency to the complications of your initial service call.</p>
<p>A new branch blooms on your decision tree. If you make this call in your service, how much latency does it add? On cold-start, can you assume the artifact will always be there? How long does it take to load the tokenizer? To stave off that branch of questions, you could instead download the artifact locally, or write your own tokenizer. Now, you&rsquo;re in the business of object storage and artifact management.</p>
<p>You decide to tackle another question: if you&rsquo;re calling the tokenizer again and again, you&rsquo;ll need to create a method, or better yet, a class, because it&rsquo;s highly likely you&rsquo;ll want other functionality attached to the tokenizer.</p>
<p>And now, if you have a service, you need to Dockerize the code. If you have a Docker image, you need to pin dependencies for reproducibility. If you are pinning dependencies and have Docker, you need a build process for your deployable artifact.</p>
<p>The closer and closer to production you get, the more questions around &ldquo;what happens if this breaks for other people who include my team and my users&rdquo; start to form.</p>
<p>You write the service and add logs. Lots of logs. So many logs. Logs are your first line of defense in production. They are the candle in the darkness. If they&rsquo;re good enough for Brian Kernighan, who wrote, &ldquo;The most effective debugging tool is still careful thought, coupled with judiciously placed print statements,‚Äù they&rsquo;re good enough for you.</p>
<p>You need to register the service into your observability platform. You add exception handling. So many <code>Exceptions</code>. What if the tokenizer doesn&rsquo;t load? What if it loads, but to the wrong directory? What if HuggingFace is down? What if the tokenizer service can&rsquo;t talk to other services? What happens if the new container doesn‚Äôt launch? What happens if the tokenizer artifact is corrupted? What happens if you&rsquo;re serving the tokenizer, but the intra-service network fails? Exceptions and logging, logging and exceptions, unit tests and integration tests, layer upon layer of defenses.</p>
<p>Beej, who previously wrote an <a href="https://beej.us/guide/bggit/html/split/index.html">incredible guide to git</a>, recently released a guide to <a href="https://beej.us/guide/bglcs/html/split/index.html">learning computer science</a>, in which he says that in order to be a good computer scientist, you need to think <a href="https://beej.us/guide/bglcs/html/split/problem-solving.html">like a villain</a>.</p>
<blockquote>
<p>Expect the unexpected in terms of data that your code will receive. Expect malicious actors to feed in data in an attempt to gain unauthorized access or manipulate the system in undesirable ways. Test for that stuff in your code.</p>
</blockquote>
<p>You think like a villain, because the villain in the production environment is usually yourself. With each new door, comes the possibility of falling through into a bottomless pit.</p>
<p>For me, this usually happens either immediately after I deploy, or at 2:17 in the morning a week from now. The tokenization method I wrote or imported fails. Or there&rsquo;s a memory leak. Or there&rsquo;s a network outage that causes a cascading failure.</p>
<p>I add more logs. I debug. I run tests. I develop locally. I add more tests. I consult and I fix, and, finally, I am back on the golden path. The alerts subside. I add more torches. The system becomes stronger, more legible from me having struggled with it. My reasoning about the system becomes stronger and clearer, too. We grow together, the system in production and me.</p>
<p>There is one comforting thought about being with the system: when you enter the Tombs, you are not actually truly alone. Software development is a team sport, and when we build a system as a team, we built it together, PR by PR.</p>
<p>And, we are also building with others: we build on the libraries and tools others before us have hardened, with the tools that others have built. In spite of the fact that an increasing amount of code is machine-assisted, software development is still mostly humans talking to each other in language that computers also understand. As we build, alone in the dark with our torches in the Tombs, we hear the echoes of others in other hallways, each carefully closing off dead ends, placing their own torches.</p>
<p>Once you illuminate enough of the system by reasoning through failure points, architectural decisions, the hallway is no longer unlimited darkness. It is an illuminated system in production. You keep <a href="https://vickiboykis.com/2025/09/09/walking-around-the-app/">walking around the app</a> and harden the system. You start to get more sleep.</p>
<p>At the end of the year, I made it out of the Tombs.</p>
<p>Just in time to go back to staring at tqdm.</p>