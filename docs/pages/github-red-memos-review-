<p>ä¸€ç›´æƒ³è¦æœ‰ä¸€ä¸ªå¹³å°ï¼Œèƒ½å¤Ÿå‘äº›ç¢ç¢å¿µä¹‹ç±»ï¼Œè®°å½•ä¸€ä¸‹åœ¨é£Ÿå ‚åƒåˆ°çš„æ–°èœå¼ï¼Œæˆ–è€…åˆ†äº«ä¸€ä¸‹æœ‰æ„æ€çš„äº‹æƒ…ã€‚å¦‚æœåœ¨ QQ ç©ºé—´åŠ¨æ€å‘ï¼Œæœªå…æœ‰äº›æ‰°æ°‘äº†ï¼›å¦‚æœåœ¨ Telegram å‘ï¼Œå› ä¸ºç½‘ç»œé—®é¢˜ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼›åœ¨çŸ¥è¯†æ˜Ÿçƒå‘ï¼Œå¾ˆä¸å¹¸æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒè´¦å·è«åå…¶å¦™åœ°è¢«åœç”¨äº†ã€‚</p>
<p>ä¹‹å‰åˆ·æ¨ç‰¹æ—¶å¶ç„¶å‘ç°äº† <a href="https://github.com/usememos/memos">memos</a> è¿™ä¸ªé¡¹ç›®ï¼Œå®šä½æ˜¯ä¸€ä¸ª Self-hosted çš„ç¬”è®°åº”ç”¨ï¼Œä½†çœ‹é¡µé¢å¾ˆåƒæ˜¯ä¸€ä¸ªç²¾ç®€ç‰ˆçš„ Twitterã€‚memos çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œä»¤æˆ‘æ„Ÿåˆ°æƒŠè®¶çš„æ˜¯ï¼Œå®ƒçš„ Repo å±…ç„¶æœ‰ 36000+ çš„ Stars æ•°ï¼Œç¡®å®å‰å®³ã€‚</p>
<p>ç¢°å·§ memos ä¹Ÿæ˜¯ç”¨ Go å†™ï¼ŒåŠŸèƒ½åˆè¿™ä¹ˆç®€å•ï¼Œæˆ‘ä¾¿æŠ½ç©ºé˜…è¯»äº†ä¸‹å®ƒçš„æºç ï¼Œä¹Ÿè¿˜ç®—æ˜¯å°æœ‰æ”¶è·ï¼Œç”¨è¿™ç¯‡æ–‡ç« åˆ†äº«ä¸‹æˆ‘çš„å¿ƒå¾—ä½“ä¼šã€‚æ–‡ä¸­æåˆ°çš„å†…å®¹å¯èƒ½ä½ å¾ˆæ—©ä»¥å‰å°±çŸ¥é“äº†ï¼Œè¿˜è¯·å¤šå¤šåŒ…æ¶µã€‚</p>
<p>æœ¬æ–‡ä½¿ç”¨ commit <a href="https://github.com/usememos/memos/tree/edc3f1d9d9f8a7b075e0f53f22dd0480cc26451e"><code>edc3f1d</code> </a> çš„ä»£ç è¿›è¡Œæ¼”ç¤ºã€‚</p>
<h2 id="è¯­ä¹‰åŒ–ç‰ˆæœ¬">è¯­ä¹‰åŒ–ç‰ˆæœ¬</h2>
<p>è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemantic Versioningï¼‰åœ¨ Go é‡Œé¢åº”è¯¥æ˜¯ç”¨å¾—å¾ˆå¤šäº†ã€‚å‡ å¹´å‰å‚åŠ  GopherChina çš„æ—¶å€™ï¼Œå°±æœ‰äººä¸“é—¨åˆ†äº«äº†è¿™ä¸ªã€‚</p>
<p>memos åœ¨ <a href="https://github.com/usememos/memos/blob/edc3f1d9d9f8a7b075e0f53f22dd0480cc26451e/server/version/version.go"><code>server/version/version.go</code></a> ä¸‹è®°å½•äº†å½“å‰çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸ºä½¿ç”¨ <code>golang.org/x/mod/semver</code> å®ç°äº†æ’åºé€»è¾‘ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ç‰ˆæœ¬å·ä¼šè¢«ç”¨äºåœ¨æ•°æ®åº“è¿ç§»ï¼ˆmigrationï¼‰ä¸­ã€‚æ¯ä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®åº“è¿ç§» SQL æ–‡ä»¶ä¼šè¢«æ”¾ç½®åœ¨ä»¥ç‰ˆæœ¬å·å‘½åçš„æ–‡ä»¶å¤¹ä¸­ï¼Œå½“æ‰§è¡Œæ•°æ®åº“è¿ç§»æ—¶ï¼Œä¼šå°†è¿™äº›ç‰ˆæœ¬å·æ–‡ä»¶åè¿›è¡Œæ’åºï¼Œå¹¶ä¸å½“å‰çš„ç‰ˆæœ¬å·è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œé€‰æ‹©è¦æ‰§è¡Œçš„è¿ç§»è„šæœ¬ã€‚</p>
<h2 id="æ‰“æ­»éƒ½ä¸ç”¨-orm">æ‰“æ­»éƒ½ä¸ç”¨ ORM</h2>
<p>memos æ”¯æŒ MySQLã€Postgresã€SQLite ä¸‰ç§æ•°æ®åº“ã€‚é‡åˆ°è¿™ç§éœ€è¦æ”¯æŒå¤šç§æ•°æ®åº“çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šä½¿ç”¨ ORMï¼Œå°±ç®—å¯¹ ORM å­˜åœ¨çš„å‰¯ä½œç”¨ä¸ä¿¡ä»»ï¼Œä¹Ÿä¼šé€‰æ‹© SQL æŸ¥è¯¢æ„é€ å™¨ï¼ˆSQL Query Builderï¼‰çš„åº“æ¥è¾…åŠ©æˆ‘ä»¬æ„é€  SQLã€‚ä½† memos ä¸çŸ¥é“åœ¨åšæŒä»€ä¹ˆï¼Œç¡¬ç”Ÿç”Ÿåœ°å¯¹ç€ä¸‰å¥—æ•°æ®åº“åç«¯å†™äº†ä¸‰å¥—ä»£ç ï¼ä»–ç”šè‡³åªç”¨ <code>database/sql</code> å’Œå¯¹åº”æ•°æ®åº“çš„ Driverï¼ä»–ç”šè‡³æ‰‹å†™ SQLï¼ä»–ç”šè‡³è¿˜å„ç§æ‹¼ SQL æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µï¼</p>
<p>å„ä½å¯ä»¥ä½“ä¼šä¸‹ <a href="https://github.com/usememos/memos/blob/edc3f1d9d9f8a7b075e0f53f22dd0480cc26451e/store/db/mysql/activity.go#L23-L27">store/db/mysql/activity.go#L23-L27</a></p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>fields <span style="color:#ff7b72;font-weight:bold">:=</span> []<span style="color:#ff7b72">string</span>{<span style="color:#a5d6ff">&#34;`creator_id`&#34;</span>, <span style="color:#a5d6ff">&#34;`type`&#34;</span>, <span style="color:#a5d6ff">&#34;`level`&#34;</span>, <span style="color:#a5d6ff">&#34;`payload`&#34;</span>}
</span></span><span style="display:flex;"><span>placeholder <span style="color:#ff7b72;font-weight:bold">:=</span> []<span style="color:#ff7b72">string</span>{<span style="color:#a5d6ff">&#34;?&#34;</span>, <span style="color:#a5d6ff">&#34;?&#34;</span>, <span style="color:#a5d6ff">&#34;?&#34;</span>, <span style="color:#a5d6ff">&#34;?&#34;</span>}
</span></span><span style="display:flex;"><span>args <span style="color:#ff7b72;font-weight:bold">:=</span> []<span style="color:#ff7b72">any</span>{create.CreatorID, create.Type.<span style="color:#d2a8ff;font-weight:bold">String</span>(), create.Level.<span style="color:#d2a8ff;font-weight:bold">String</span>(), payloadString}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stmt <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#a5d6ff">&#34;INSERT INTO `activity` (&#34;</span> <span style="color:#ff7b72;font-weight:bold">+</span> strings.<span style="color:#d2a8ff;font-weight:bold">Join</span>(fields, <span style="color:#a5d6ff">&#34;, &#34;</span>) <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">&#34;) VALUES (&#34;</span> <span style="color:#ff7b72;font-weight:bold">+</span> strings.<span style="color:#d2a8ff;font-weight:bold">Join</span>(placeholder, <span style="color:#a5d6ff">&#34;, &#34;</span>) <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">&#34;)&#34;</span>
</span></span></code></pre></div><p>è¿™æ®µ <code>INSERT</code> çœŸå°±ç¡¬ç”Ÿç”Ÿåœ°æ‹¼å­—æ®µï¼Œç¡¬ç”Ÿç”Ÿçš„å†™æ­»é¢„ç¼–è¯‘å ä½ç¬¦ã€‚</p>
<p>å½“ç„¶ï¼Œæœ‰äººæäº† issue é—®ä¸ºä»€ä¹ˆä¸ç”¨ ORMï¼Œå¹¶ä¸”æ¨èäº† <code>sqlc</code> å’Œ <code>sqlbuilders</code> ä¸¤ä¸ªåº“ã€‚ä½œè€…çš„å›å¤æ˜¯å‰è€… <code>looks a little weird</code> ï¼ˆï¼Ÿï¼‰ï¼Œåè€… <code> pretty much the same as the existing way</code>ï¼Œç»¼ä¸Šæ‰€å±ä½œè€…è®¤ä¸ºä¿æŒç°çŠ¶å•¥ä¹Ÿä¸æ”¹ï¼ğŸ˜…</p>
<p>FYIï¼š<a href="https://github.com/usememos/memos/issues/2517">https://github.com/usememos/memos/issues/2517</a></p>
<h2 id="ç©å‡ºèŠ±çš„-grpc">ç©å‡ºèŠ±çš„ gRPC</h2>
<p>memos é¡¹ç›®ä¸­å¯¹ gRPC çš„å†™æ³•å¯è°“æ˜¯æ•™ç§‘ä¹¦çº§åˆ«çš„ã€‚æˆ‘ä¹Ÿç®—æ˜¯å¯¹ç€å®ƒçš„ä»£ç å…¥é—¨äº†ä¸‹ gRPCã€‚è¯´æ¥æƒ­æ„§ï¼Œæˆ‘ä»¥å‰é™¤äº†æ‹¿ Protobuf å†™è¿‡ Hello World çš„ demoï¼Œå°±æ²¡æœ‰æ›´æ·±å…¥çš„åº”ç”¨äº†ã€‚</p>
<h3 id="buf">Buf</h3>
<p><a href="https://github.com/bufbuild/buf">Buf</a> æ˜¯ä¸€ä¸ªç”¨æ¥è¾…åŠ©ä½¿ç”¨ Protobuf çš„å·¥å…·ã€‚å®ƒç›¸å½“äºä¸º Protobuf å®ç°äº†â€œåŒ…ç®¡ç†â€çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>buf.yaml</code> æ¥å®šä¹‰éœ€è¦å¼•ç”¨çš„ç¬¬ä¸‰æ–¹ Protoï¼Œè¿˜å¯ä»¥é…ç½® Lint ä¹‹ç±»çš„è§„åˆ™ã€‚è¿è¡Œ <code>buf generate</code> åä¾¿ä¼šè‡ªåŠ¨å»å¸®æˆ‘ä»¬å®Œæˆè¿è¡Œ <code>protoc-gen-go</code> ç­‰ä¸€åˆ‡æ“ä½œã€‚memos ä¸­å°±ä½¿ç”¨åˆ°äº† Bufï¼Œå¯ä»¥åœ¨ <a href="https://github.com/usememos/memos/blob/edc3f1d9d9f8a7b075e0f53f22dd0480cc26451e/proto/buf.yaml"><code>proto/buf.yaml</code></a> æ‰¾åˆ°ã€‚Buf è¿˜ä¼šç”Ÿæˆä¸€ä¸ª <code>buf.lock</code> æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯åŒ…ç®¡ç†ä¸­å¸¸è§çš„ç­¾åæ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ° Buf çš„ <code>dep</code> ä¾èµ–å½¢å¦‚ <code>buf.build/googleapis/googleapis</code> è¿™æ ·çš„ URLï¼Œè®¿é—®ä¾¿å¯è·³è½¬åˆ° Buf Schema Registry ä¸Šå¯¹åº” Package çš„é¡µé¢ã€‚</p>
<p>æ„Ÿè§‰ç”¨ Buf æ¥å¤„ç† Protobufï¼Œæ“ä½œç®€ä¾¿ï¼Œé€¼æ ¼ä¸€ä¸‹å°±ä¸Šå»äº†ï¼Œå­¦åˆ°äº†ã€‚</p>
<h3 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h3>
<p>memos çš„ <code>/proto</code> ç›®å½•ä¸‹ï¼Œ<code>store</code> ç›®å½•ä¸æ•°æ®åº“çš„è¡¨ç»“æ„å¯¹åº”ï¼Œä¸ºæ¯å¼ è¡¨å¯¹åº”çš„å®ä¾‹çš„ proto å®šä¹‰ã€‚<code>api/v1</code> ç›®å½•ä¸­åˆ™æ˜¯ <code>service</code> çš„å®šä¹‰ï¼Œè¿™é‡Œåˆ™å¯¹åº”äº† Web API çš„è·¯ç”±ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff7b72">service</span> AuthService {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#8b949e;font-style:italic">// GetAuthStatus returns the current auth status of the user.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span> <span style="color:#ff7b72">rpc</span> GetAuthStatus(GetAuthStatusRequest) <span style="color:#ff7b72">returns</span> (User) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {post<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/auth/status&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> }<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#8b949e;font-style:italic">// SignIn signs in the user with the given username and password.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span> <span style="color:#ff7b72">rpc</span> SignIn(SignInRequest) <span style="color:#ff7b72">returns</span> (User) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {post<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/auth/signin&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> }<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#8b949e;font-style:italic">// SignInWithSSO signs in the user with the given SSO code.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span> <span style="color:#ff7b72">rpc</span> SignInWithSSO(SignInWithSSORequest) <span style="color:#ff7b72">returns</span> (User) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {post<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/auth/signin/sso&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> }<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#8b949e;font-style:italic">// SignUp signs up the user with the given username and password.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span> <span style="color:#ff7b72">rpc</span> SignUp(SignUpRequest) <span style="color:#ff7b72">returns</span> (User) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {post<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/auth/signup&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> }<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#8b949e;font-style:italic">// SignOut signs out the user.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span> <span style="color:#ff7b72">rpc</span> SignOut(SignOutRequest) <span style="color:#ff7b72">returns</span> (google.protobuf.Empty) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {post<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/auth/signout&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> }<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span>}<span style="color:#f85149">
</span></span></span></code></pre></div><p>ä¾‹å¦‚ä¸Šè¿°ä»£ç ï¼Œ<code>service</code> ä¸­çš„æ¯ä¸ª <code>rpc</code> å¯ä»¥çœ‹ä½œä¸ä¸€ä¸ª API ç›¸å¯¹åº”ã€‚</p>
<p>ä¾‹å¦‚ <code>GetAuthStatusRequest</code> è¿™äº›æ˜¯åœ¨ä¸‹é¢å®šä¹‰çš„ <code>message</code> ï¼Œç›¸å½“äºæ˜¯æ¥å£çš„å…¥å‚è¡¨å•ï¼Œ<code>returns</code> æŒ‡å®šäº†è¿”å›å€¼ã€‚æ²¡æœ‰è¿”å›å€¼çš„æ¥å£åˆ™ä½¿ç”¨äº† <code>google.protobuf.Empty</code> ã€‚</p>
<p><code>option</code> æŒ‡å®šäº† HTTP ä¸‹çš„è¯·æ±‚è·¯ç”±å’Œè¯·æ±‚æ–¹æ³•ã€‚</p>
<p>å¯¹äºåŠ¨æ€è·¯ç”±ï¼Œæ„Ÿè§‰ä¼šæœ‰äº›å¤æ‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#ff7b72">rpc</span> GetMemo(GetMemoRequest) <span style="color:#ff7b72">returns</span> (Memo) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {get<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/{name=memos/*}&#34;</span>};<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.method_signature) <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;name&#34;</span>;<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span>}<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span><span style="color:#ff7b72">rpc</span> UpdateMemo(UpdateMemoRequest) <span style="color:#ff7b72">returns</span> (Memo) {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.http) <span style="color:#ff7b72;font-weight:bold">=</span> {<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> patch<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;/api/v1/{memo.name=memos/*}&#34;</span><span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> body<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;memo&#34;</span><span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> };<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span> <span style="color:#ff7b72">option</span> (google.api.method_signature) <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;memo,update_mask&#34;</span>;<span style="color:#f85149">
</span></span></span><span style="display:flex;"><span><span style="color:#f85149"></span>}<span style="color:#f85149">
</span></span></span></code></pre></div><p>ç¬¬ä¸€ä¸ª <code>GetMemo</code> ä¸­ï¼Œé™åˆ¶äº†è·¯ç”±çš„å¿…é¡»è¦åŒ¹é…åˆ° <code>/api/v1/memos/*</code> ï¼Œåé¢çš„ <code>method_signature</code> æŒ‡å®šäº†å¿…é¡»è¦ä¼  <code>name</code> å‚æ•°ã€‚</p>
<p>ç¬¬äºŒä¸ª <code>UpdateMemo</code> ä¸­ï¼Œé™åˆ¶äº†è·¯ç”±å¿…é¡»åŒ¹é… <code>/api/v1/memos/*</code> ã€‚å¤§æ‹¬å·é‡Œæœ‰ä¸ªå¾ˆæ€ªçš„ <code>memo.name=</code>ï¼Œå› ä¸º proto é‡Œå‚æ•°éƒ½æ˜¯åœ¨ rpc çš„å…¥å‚ä¼ å…¥çš„ï¼ˆå³ <code>UpdateMemoRequest</code> ï¼‰ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨é€šè¿‡ HTTP API è®¿é—®æ—¶æ‰æœ‰ Pathã€Headerã€Queryã€Body è¿™äº›ä¼ å‚çš„æ–¹å¼ã€‚å› æ­¤åœ¨ <code>rpc</code> çš„å®šä¹‰é‡Œï¼Œè·¯ç”±ä¸­é€šé…ç¬¦çš„å€¼æ¥è‡ªäº <code>UpdateMemoRequest</code> ä¸­çš„ <code>memo.name</code> ã€‚è€Œåé¢çš„ <code>method_signature</code> æŒ‡å®šäº† <code>memo</code> å’Œ <code>update_mask</code> ä¸ºå¿…é¡»è¦ä¼ çš„å‚æ•°ã€‚</p>
<p>Service çš„å…·ä½“å®ç°ä¸Šï¼Œå…¶å®è·Ÿæ­£å¸¸å†™ HTTP æ¥å£å·®ä¸å¤šï¼ŒService ç»“æ„ä½“å®ç°å¯¹åº” interface é‡Œå®šä¹‰çš„æ–¹æ³•å³å¯ã€‚æˆ‘æ³¨æ„åˆ°æ–¹æ³•çš„é”™è¯¯å¤„ç†ï¼Œä½¿ç”¨çš„æ˜¯ <code>google.golang.org/grpc/status</code> æ„é€ çš„ <code>error</code>ï¼ŒçŠ¶æ€ç ä¹Ÿæ˜¯ grpc åŒ…é‡Œè‡ªå¸¦çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span> (s <span style="color:#ff7b72;font-weight:bold">*</span>APIV1Service) <span style="color:#d2a8ff;font-weight:bold">GetMemo</span>(ctx context.Context, request <span style="color:#ff7b72;font-weight:bold">*</span>v1pb.GetMemoRequest) (<span style="color:#ff7b72;font-weight:bold">*</span>v1pb.Memo, <span style="color:#ff7b72">error</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, status.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(codes.PermissionDenied, <span style="color:#a5d6ff">&#34;permission denied&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>codes</code> åŒ…é‡Œå®šä¹‰äº† 17 ç§çŠ¶æ€ç ï¼Œæˆ‘å¼€å§‹è¿˜æ€€ç–‘å°±è¿™ä¹ˆç‚¹çŠ¶æ€ç ç±»å‹çœŸçš„èƒ½ç»™æ‰€æœ‰çš„é”™è¯¯åˆ†ç±»å—ï¼Ÿäº‹å®è¯æ˜è¿˜çœŸå¯ä»¥ã€‚åƒ RESTful API é‡Œå¸¸å¸¸è¡¨ç¤ºçš„ <code>403</code> æ²¡æƒé™ã€<code>404</code> ä¸å­˜åœ¨ã€<code>400</code> æ ¼å¼ä¸å¯¹ã€<code>5xx</code> æœåŠ¡å¯„äº† ç­‰çŠ¶æ€ï¼Œéƒ½å¯ä»¥æ‰¾åˆ°çŠ¶æ€ç è¿›è¡Œå¯¹åº”ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> strToCode = <span style="color:#ff7b72">map</span>[<span style="color:#ff7b72">string</span>]Code{
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;OK&#34;`</span>: OK,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;CANCELLED&#34;`</span>:<span style="color:#8b949e;font-style:italic">/* [sic] */</span> Canceled,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;UNKNOWN&#34;`</span>: Unknown,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;INVALID_ARGUMENT&#34;`</span>: InvalidArgument,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;DEADLINE_EXCEEDED&#34;`</span>: DeadlineExceeded,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;NOT_FOUND&#34;`</span>: NotFound,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;ALREADY_EXISTS&#34;`</span>: AlreadyExists,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;PERMISSION_DENIED&#34;`</span>: PermissionDenied,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;RESOURCE_EXHAUSTED&#34;`</span>: ResourceExhausted,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;FAILED_PRECONDITION&#34;`</span>: FailedPrecondition,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;ABORTED&#34;`</span>: Aborted,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;OUT_OF_RANGE&#34;`</span>: OutOfRange,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;UNIMPLEMENTED&#34;`</span>: Unimplemented,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;INTERNAL&#34;`</span>: Internal,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;UNAVAILABLE&#34;`</span>: Unavailable,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;DATA_LOSS&#34;`</span>: DataLoss,
</span></span><span style="display:flex;"><span> <span style="color:#a5d6ff">`&#34;UNAUTHENTICATED&#34;`</span>: Unauthenticated,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="grpc-server-å’Œ-restful-api-server">gRPC Server å’Œ RESTful API Server</h3>
<p>memos çš„ <code>server/server.go</code> æ–‡ä»¶å®šä¹‰äº† HTTP æœåŠ¡ã€‚å®ƒçš„ HTTP æœåŠ¡ä½¿ç”¨ echo æ¡†æ¶ã€‚</p>
<p>é‡ç‚¹çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>grpcServer <span style="color:#ff7b72;font-weight:bold">:=</span> grpc.<span style="color:#d2a8ff;font-weight:bold">NewServer</span>(
</span></span><span style="display:flex;"><span> <span style="color:#8b949e;font-style:italic">// Override the maximum receiving message size to math.MaxInt32 for uploading large resources.</span>
</span></span><span style="display:flex;"><span> grpc.<span style="color:#d2a8ff;font-weight:bold">MaxRecvMsgSize</span>(math.MaxInt32),
</span></span><span style="display:flex;"><span> grpc.<span style="color:#d2a8ff;font-weight:bold">ChainUnaryInterceptor</span>(
</span></span><span style="display:flex;"><span> apiv1.<span style="color:#d2a8ff;font-weight:bold">NewLoggerInterceptor</span>().LoggerInterceptor,
</span></span><span style="display:flex;"><span> grpcrecovery.<span style="color:#d2a8ff;font-weight:bold">UnaryServerInterceptor</span>(),
</span></span><span style="display:flex;"><span> apiv1.<span style="color:#d2a8ff;font-weight:bold">NewGRPCAuthInterceptor</span>(store, secret).AuthenticationInterceptor,
</span></span><span style="display:flex;"><span> ))
</span></span><span style="display:flex;"><span>s.grpcServer = grpcServer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiV1Service <span style="color:#ff7b72;font-weight:bold">:=</span> apiv1.<span style="color:#d2a8ff;font-weight:bold">NewAPIV1Service</span>(s.Secret, profile, store, grpcServer)
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Register gRPC gateway as api v1.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> apiV1Service.<span style="color:#d2a8ff;font-weight:bold">RegisterGateway</span>(ctx, echoServer); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;failed to register gRPC gateway&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™é‡Œé¦–å…ˆå£°æ˜äº†ä¸€ä¸ª gRPC Serverï¼Œå¹¶åŠ äº†äº›å¸¸è§çš„ Recover ä¸­é—´ä»¶ã€Logger æ‹¦æˆªå™¨ã€ACL é‰´æƒæ‹¦æˆªå™¨ç­‰ã€‚</p>
<p>åé¢çš„ <code>NewAPIV1Service</code> åˆ›å»ºæ¯ä¸€å—æ¥å£çš„ ServiceServerã€‚è·Ÿè¿›å»å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¼šå‘ä¸Šè¿°å®šä¹‰çš„ gRPC Server æ³¨å†Œæ‰€æ”¯æŒçš„æœåŠ¡ã€‚è¿™äº›æ³¨å†ŒæœåŠ¡çš„ <code>v1pb.RegisterXXXServiceServer</code> å°±æ˜¯ç”¨ proto æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span> <span style="color:#d2a8ff;font-weight:bold">NewAPIV1Service</span>(secret <span style="color:#ff7b72">string</span>, profile <span style="color:#ff7b72;font-weight:bold">*</span>profile.Profile, store <span style="color:#ff7b72;font-weight:bold">*</span>store.Store, grpcServer <span style="color:#ff7b72;font-weight:bold">*</span>grpc.Server) <span style="color:#ff7b72;font-weight:bold">*</span>APIV1Service {
</span></span><span style="display:flex;"><span> grpc.EnableTracing = <span style="color:#79c0ff">true</span>
</span></span><span style="display:flex;"><span> apiv1Service <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>APIV1Service{
</span></span><span style="display:flex;"><span> Secret: secret,
</span></span><span style="display:flex;"><span> Profile: profile,
</span></span><span style="display:flex;"><span> Store: store,
</span></span><span style="display:flex;"><span> grpcServer: grpcServer,
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterWorkspaceServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterWorkspaceSettingServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterAuthServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterUserServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterMemoServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterResourceServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterInboxServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterActivityServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterWebhookServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterMarkdownServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterIdentityProviderServiceServer</span>(grpcServer, apiv1Service)
</span></span><span style="display:flex;"><span> reflection.<span style="color:#d2a8ff;font-weight:bold">Register</span>(grpcServer)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> apiv1Service
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æœ€åçš„ <code>reflection.Register(grpcServer)</code> ç”¨äºæ³¨å†Œ gRPC çš„åå°„åŠŸèƒ½ï¼Œè®©å®¢æˆ·ç«¯åœ¨è¿è¡Œæ—¶èƒ½åŠ¨æ€è·å– gRPC æœåŠ¡çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœåŠ¡åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€æ–¹æ³•çš„è¾“å…¥è¾“å‡ºå‚æ•°ç±»å‹ç­‰ï¼Œè€Œä¸éœ€è¦äº‹å…ˆçŸ¥é“æœåŠ¡çš„å…·ä½“å®šä¹‰ã€‚</p>
<hr>
<p>å‘ gRPC Server æ³¨å†Œå®ŒæœåŠ¡åï¼Œä¸‹é¢æ˜¯<strong>å°† Echo æ¡†æ¶å¯åŠ¨çš„ HTTP Server ä½œä¸º Gatewayï¼Œä»¥å®ç°é€šè¿‡ HTTP çš„æ–¹å¼æ¥è®¿é—® gRPC Serviceã€‚</strong>ï¼ˆechoServer å°±æ˜¯ <code>echo.New()</code> å‡ºæ¥çš„å®ä¾‹ï¼‰</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Register gRPC gateway as api v1.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> apiV1Service.<span style="color:#d2a8ff;font-weight:bold">RegisterGateway</span>(ctx, echoServer); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;failed to register gRPC gateway&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è·Ÿè¿›å»çœ‹å®šä¹‰ã€‚è¿™é‡Œå±…ç„¶æ–°å»ºäº†ä¸€ä¸ª gRPC çš„å®¢æˆ·ç«¯ï¼</p>
<p><code>runtime.NewServeMux()</code> æ˜¯ <code>grpc-gateway</code> ä¸‹çš„åŒ…ï¼Œç”¨äºè¿”å›ä¸€ä¸ª HTTP Muxï¼Œåç»­å°±å¯ä»¥äº¤ç»™ä»»æ„çš„ Go HTTP æ¡†æ¶å»è°ƒç”¨ã€‚ä¸‹é¢è‡ªåŠ¨ç”Ÿæˆçš„ <code>v1pb.RegisterXXXServiceHandler</code> è¿™äº›è·¯ç”± Handlerï¼Œå°±æ˜¯æ¥è‡ªäºä¸Šæ–‡ proto æ–‡ä»¶é‡Œçš„ <code>google.api.http</code> æ³¨è§£ã€‚</p>
<p>æœ€åå°†è¿™ä¸ª HTTP Mux åŒ…èµ·æ¥äº¤ç»™ echo æ¡†æ¶çš„ handlerï¼Œæ”¾åœ¨äº† <code>/api/v1/*</code> è·¯ç”±ä¸‹ã€‚è¿™æ ·æˆ‘ä»¬å°±å®ç°äº† RESTful é£æ ¼çš„ APIã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// RegisterGateway registers the gRPC-Gateway with the given Echo instance.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">func</span> (s <span style="color:#ff7b72;font-weight:bold">*</span>APIV1Service) <span style="color:#d2a8ff;font-weight:bold">RegisterGateway</span>(ctx context.Context, echoServer <span style="color:#ff7b72;font-weight:bold">*</span>echo.Echo) <span style="color:#ff7b72">error</span> {
</span></span><span style="display:flex;"><span> conn, err <span style="color:#ff7b72;font-weight:bold">:=</span> grpc.<span style="color:#d2a8ff;font-weight:bold">NewClient</span>(
</span></span><span style="display:flex;"><span> fmt.<span style="color:#d2a8ff;font-weight:bold">Sprintf</span>(<span style="color:#a5d6ff">&#34;%s:%d&#34;</span>, s.Profile.Addr, s.Profile.Port),
</span></span><span style="display:flex;"><span> grpc.<span style="color:#d2a8ff;font-weight:bold">WithTransportCredentials</span>(insecure.<span style="color:#d2a8ff;font-weight:bold">NewCredentials</span>()),
</span></span><span style="display:flex;"><span> grpc.<span style="color:#d2a8ff;font-weight:bold">WithDefaultCallOptions</span>(grpc.<span style="color:#d2a8ff;font-weight:bold">MaxCallRecvMsgSize</span>(math.MaxInt32)),
</span></span><span style="display:flex;"><span> )
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> err
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> gwMux <span style="color:#ff7b72;font-weight:bold">:=</span> runtime.<span style="color:#d2a8ff;font-weight:bold">NewServeMux</span>()
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterWorkspaceServiceHandler</span>(ctx, gwMux, conn); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> err
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#8b949e;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> v1pb.<span style="color:#d2a8ff;font-weight:bold">RegisterIdentityProviderServiceHandler</span>(ctx, gwMux, conn); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> err
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> gwGroup <span style="color:#ff7b72;font-weight:bold">:=</span> echoServer.<span style="color:#d2a8ff;font-weight:bold">Group</span>(<span style="color:#a5d6ff">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> gwGroup.<span style="color:#d2a8ff;font-weight:bold">Use</span>(middleware.<span style="color:#d2a8ff;font-weight:bold">CORS</span>())
</span></span><span style="display:flex;"><span> handler <span style="color:#ff7b72;font-weight:bold">:=</span> echo.<span style="color:#d2a8ff;font-weight:bold">WrapHandler</span>(gwMux)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> gwGroup.<span style="color:#d2a8ff;font-weight:bold">Any</span>(<span style="color:#a5d6ff">&#34;/api/v1/*&#34;</span>, handler)
</span></span><span style="display:flex;"><span> gwGroup.<span style="color:#d2a8ff;font-weight:bold">Any</span>(<span style="color:#a5d6ff">&#34;/file/*&#34;</span>, handler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8b949e;font-style:italic">// GRPC web proxy.</span>
</span></span><span style="display:flex;"><span> options <span style="color:#ff7b72;font-weight:bold">:=</span> []grpcweb.Option{
</span></span><span style="display:flex;"><span> grpcweb.<span style="color:#d2a8ff;font-weight:bold">WithCorsForRegisteredEndpointsOnly</span>(<span style="color:#79c0ff">false</span>),
</span></span><span style="display:flex;"><span> grpcweb.<span style="color:#d2a8ff;font-weight:bold">WithOriginFunc</span>(<span style="color:#ff7b72">func</span>(_ <span style="color:#ff7b72">string</span>) <span style="color:#ff7b72">bool</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">true</span>
</span></span><span style="display:flex;"><span> }),
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> wrappedGrpc <span style="color:#ff7b72;font-weight:bold">:=</span> grpcweb.<span style="color:#d2a8ff;font-weight:bold">WrapServer</span>(s.grpcServer, options<span style="color:#ff7b72;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span> echoServer.<span style="color:#d2a8ff;font-weight:bold">Any</span>(<span style="color:#a5d6ff">&#34;/memos.api.v1.*&#34;</span>, echo.<span style="color:#d2a8ff;font-weight:bold">WrapHandler</span>(wrappedGrpc))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸‹é¢è¿˜å£°æ˜äº†ä¸€ä¸ª gRPC Web Proxyï¼Œè¿™ä¸ªæ˜¯ç”¨ HTTP çš„æ–¹å¼æ¥è°ƒ gRPCã€‚ä½¿ç”¨çš„ <code>grpcweb</code> åŒ…ï¼Œè°ƒç”¨æ¥å£ä¼ å‚å¹¶ä¸æ˜¯ç”¨çš„ Query æˆ–è€… Bodyï¼Œè€Œæ˜¯ protobuf å°†å‚æ•°åºåˆ—åŒ–åå†å‘é€é‚£å¥—ã€‚è·Ÿèµ°çº¯ TCP ç›¸æ¯”ï¼Œä»…ä»…åªæ˜¯è¿™é‡Œèµ°çš„æ˜¯ HTTP è¯·æ±‚è€Œå·²ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯è®©æµè§ˆå™¨èƒ½è·Ÿ gRPC Server é€šä¿¡äº†ã€‚</p>
<p>è€Œæµè§ˆå™¨ä¸­è°ƒç”¨ä¼šæœ‰åŒæºè·¨åŸŸçš„é—®é¢˜ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ <code>grpcweb.Option</code> ä¹Ÿæ˜¯é€é‡è§£å†³ CORS å’Œ Originã€‚</p>
<p>å¸Œæœ›çœ‹åˆ°è¿™é‡Œä½ æ²¡è¢«ç»•æ™•ã€‚ä½ ä¼šå‘ç°ï¼Œ<strong>memos å…¶å®æ˜¯ç”¨ HTTP å®ç°äº†ä¸¤å¥—æœåŠ¡ï¼šRESTful API å’Œ gRPC Server API</strong>ã€‚è¿™ä¸¤å¥—èƒŒåçš„ä¸šåŠ¡é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸”éƒ½æ˜¯ä½¿ç”¨ HTTP åè®®ï¼Œä¸åŒç‚¹åœ¨äºè·¯ç”±å’Œä¼ å‚çš„æ–¹å¼ä¸ä¸€æ ·ã€‚</p>
<h3 id="ç«¯å£å¤ç”¨">ç«¯å£å¤ç”¨</h3>
<p>æœ‰ä¸ªæ¯”è¾ƒæŠ½è±¡çš„å°ç»†èŠ‚ä¸çŸ¥é“ä½ å‘ç°äº†æ²¡æœ‰ï¼ŒgRPC Server -&gt; gRPC Server API åªéœ€è¦ç”¨ grpcweb åŒ…ä¸€ä¸‹å°±è¡Œäº†ï¼Œä½† RESTful API éœ€è¦å†æœ¬åœ°å»ºä¸€ä¸ª gRPC Clientï¼Œç„¶åè¿™ä¸ª Client è‡ªå·±è¯·æ±‚æœ¬åœ°çš„ Serverã€‚æ•´æ¡é“¾è·¯æ˜¯ HTTP Mux -&gt; Handler Func -&gt; gRPC Client -&gt; gRPC Serverã€‚è€Œè¿™ä¸ª gRPC Client ç›‘å¬çš„ç«¯å£ï¼Œå±…ç„¶ä¸å¯¹å¤–çš„ HTTP æœåŠ¡çš„ç«¯å£æ˜¯ä¸€æ ·çš„ï¼</p>
<p>æ¢å¥è¯è¯´ï¼Œå°±æ˜¯ <strong>gRPC Server å’Œ echo HTTP Server å¤ç”¨äº†åŒä¸€ä¸ªç«¯å£</strong>ã€‚</p>
<p>è¿™é‡Œæ˜¯ä½¿ç”¨äº† <a href="http://github.com/soheilhy/cmux">github.com/soheilhy/cmux</a> è¿™ä¸ªåº“æ¥å®ç°ã€‚è¿™ä¸ªåº“æ”¯æŒå®šä¹‰ Matcher æ¡ä»¶ï¼Œå“ªä¸ªåŒ¹é…ä¸Šäº†å°±èµ°å“ªä¸ªçš„ Serveã€‚</p>
<p>åƒ gRPC Server åœ¨é€šè¿‡ HTTP è°ƒç”¨æ—¶ï¼Œé€šè¿‡ Body å‘é€ Protobuf æŠ¥æ–‡ï¼Œ<code>Content-Type</code> ä¸º <code>application/grpc</code>ï¼›è€Œ RESTful API åˆ™æ˜¯å¸¸è§„çš„ HTTP è¯·æ±‚ï¼Œé™¤äº† <code>PATCH</code> æ–¹æ³•å¤–éƒ½ä¼šå‘½ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>muxServer <span style="color:#ff7b72;font-weight:bold">:=</span> cmux.<span style="color:#d2a8ff;font-weight:bold">New</span>(listener)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">go</span> <span style="color:#ff7b72">func</span>() {
</span></span><span style="display:flex;"><span> grpcListener <span style="color:#ff7b72;font-weight:bold">:=</span> muxServer.<span style="color:#d2a8ff;font-weight:bold">MatchWithWriters</span>(cmux.<span style="color:#d2a8ff;font-weight:bold">HTTP2MatchHeaderFieldSendSettings</span>(<span style="color:#a5d6ff">&#34;content-type&#34;</span>, <span style="color:#a5d6ff">&#34;application/grpc&#34;</span>))
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> s.grpcServer.<span style="color:#d2a8ff;font-weight:bold">Serve</span>(grpcListener); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> slog.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;failed to serve gRPC&#34;</span>, <span style="color:#a5d6ff">&#34;error&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}()
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">go</span> <span style="color:#ff7b72">func</span>() {
</span></span><span style="display:flex;"><span> httpListener <span style="color:#ff7b72;font-weight:bold">:=</span> muxServer.<span style="color:#d2a8ff;font-weight:bold">Match</span>(cmux.<span style="color:#d2a8ff;font-weight:bold">HTTP1Fast</span>(http.MethodPatch))
</span></span><span style="display:flex;"><span> s.echoServer.Listener = httpListener
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> s.echoServer.<span style="color:#d2a8ff;font-weight:bold">Start</span>(address); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> slog.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;failed to start echo server&#34;</span>, <span style="color:#a5d6ff">&#34;error&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}()
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">go</span> <span style="color:#ff7b72">func</span>() {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> muxServer.<span style="color:#d2a8ff;font-weight:bold">Serve</span>(); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> slog.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;mux server listen error&#34;</span>, <span style="color:#a5d6ff">&#34;error&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></div><p>è¿™é‡Œå¯¹ gRPC çš„æ“ä½œå±å®å¦™å“‰ï¼ç«¯å£å¤ç”¨çš„æ“ä½œæ›´æ˜¯ä¸€ç»ã€‚æƒ³èµ·æˆ‘ä¹‹å‰æœ‰ä¸ª Side Projectï¼Œæ—¢éœ€è¦è·‘å¯¹å¤–çš„ Web Server åç«¯ï¼Œåˆéœ€è¦è·‘å¯¹å†…çš„ API Server åç«¯ï¼Œå½“æ—¶çš„åšæ³•æ˜¯ç›‘å¬ä¸¤ä¸ªä¸åŒç«¯å£ï¼Œç°åœ¨æƒ³æ¥å¯ä»¥ç”¨ cmux æ¥å®ç°ç«¯å£å¤ç”¨äº†ã€‚</p>
<h3 id="æ¢¦å¼€å§‹çš„åœ°æ–¹">æ¢¦å¼€å§‹çš„åœ°æ–¹</h3>
<p>é‚£ä¹ˆè¯·é—®ï¼Œä¸Šè¿°è¿™ç§æ•™ç§‘ä¹¦çº§åˆ«çš„ Protobuf å’Œ gRPC çš„ç”¨æ³•ï¼Œæ˜¯æ¥è‡ªäºå“ªé‡Œçš„å‘¢ï¼Ÿ</p>
<p>æˆ‘è§‚å¯Ÿåˆ° memos çš„ä½œè€…å±…ç„¶ä¹Ÿç»™ Bytebase æäº¤è¿‡ä»£ç ï¼Œå¥½å®¶ä¼™ï¼Œè€ç†Ÿäººå•Šã€‚åŒæ—¶ï¼Œæˆ‘åœ¨ Bytebase çš„ä»“åº“é‡Œï¼Œæ‰¾åˆ°äº† <a href="https://github.com/bytebase/bytebase/pull/3751">#3751</a> è¿™ä¸ª PRã€‚<del>ï¼ˆä¸‡æ¶ä¹‹æºï¼‰</del></p>
<p>åœ¨ 2022 å¹´ 12 æœˆï¼ˆå¥½åƒå°±æ˜¯ DevJoy ç»“æŸåä¸€ä¸ªæœˆï¼‰ï¼ŒBytebase ä»“åº“å¼•å…¥äº†ç¬¬ä¸€ä¸ª proto æ–‡ä»¶ã€‚ä»æ­¤ä¾¿ä¸€å‘ä¸å¯æ”¶æ‹¾ï¼ŒåŸå…ˆçš„ Web API å…¨éƒ½å˜æˆäº† gRPC Server çš„å†™æ³•ï¼ŒåŒæ—¶ä¹Ÿå¼€å§‹ä½¿ç”¨ Buf æ¥ç®¡ç† proto æ–‡ä»¶ã€‚memos çš„ä½œè€…ä½œä¸ºåé¢åŠ å…¥ Bytebase çš„å‘˜å·¥ï¼Œä¹Ÿæ˜¯å°† Bytebase å¯¹äº gRPC çš„æœ€ä½³å®è·µï¼Œç”¨åœ¨äº†ä»–çš„ Side Projectï¼Œä¹Ÿå°±æ˜¯ memos ä¸­ã€‚</p>
<p>æˆ‘æƒ³å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæ•…äº‹æƒ…èŠ‚å§ã€‚ğŸ˜</p>
<h2 id="å®šæ—¶ä»»åŠ¡">å®šæ—¶ä»»åŠ¡</h2>
<p>memos å†…éƒ¨è‡ªè¡Œå®ç°äº†ä¸‰ä¸ªå¾ˆåŸºç¡€çš„å®šæ—¶ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆè¯´å¾ˆåŸºç¡€å‘¢ï¼Œå› ä¸ºå°±æ˜¯ä½¿ç”¨ <code>time.NewTicker</code> æ¥åšçš„ã€‚æ¯ä¸ªå®šæ—¶ä»»åŠ¡çš„ Runner éƒ½ä¼šå®ç° <code>Run()</code> å’Œ <code>RunOnce()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œå¯èƒ½å¯ä»¥å®šä¹‰æˆä¸€ä¸ªæ¥å£ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span> (r <span style="color:#ff7b72;font-weight:bold">*</span>Runner) <span style="color:#d2a8ff;font-weight:bold">Run</span>(ctx context.Context) {
</span></span><span style="display:flex;"><span> ticker <span style="color:#ff7b72;font-weight:bold">:=</span> time.<span style="color:#d2a8ff;font-weight:bold">NewTicker</span>(runnerInterval)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">defer</span> ticker.<span style="color:#d2a8ff;font-weight:bold">Stop</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">for</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">select</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#ff7b72;font-weight:bold">&lt;-</span>ticker.C:
</span></span><span style="display:flex;"><span> r.<span style="color:#d2a8ff;font-weight:bold">RunOnce</span>(ctx)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#ff7b72;font-weight:bold">&lt;-</span>ctx.<span style="color:#d2a8ff;font-weight:bold">Done</span>():
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸‰ä¸ªå®šæ—¶ä»»åŠ¡åˆ†åˆ«æ˜¯ <code>s3presign</code> <code>version</code> <code>memopreperty</code> ã€‚</p>
<ul>
<li>
<p><code>s3presign</code> æ¯ 12 ä¸ªå°æ—¶éå†ä¸€æ³¢æ•°æ®åº“ä¸­å­˜å‚¨çš„ä¸Šä¼ åˆ° S3 çš„èµ„æºï¼Œå°†ä¸´æ—¶ URL æœ‰æ•ˆæœŸä¸åˆ°ä¸€å¤©çš„èµ„æºï¼Œé‡æ–°è°ƒç”¨ S3 SDK ä¸­çš„ PreSign ç­¾ä¸€ä¸ªäº”å¤©çš„ä¸´æ—¶ URLã€‚memos åœ¨æ•°æ®åº“ä¸­å­˜å‚¨å›¾ç‰‡ç­‰èµ„æºçš„ä¸´æ—¶ URLï¼Œæ„Ÿè§‰æ˜¯ä¸ºäº†é˜²æ­¢ç§æœ‰ç¬”è®°ä¸­çš„èµ„æº URL æ³„éœ²ã€‚ä½¿ç”¨ PreSign URL åï¼Œå³ä½¿å°†å…¬å¼€ç¬”è®°è½¬ä¸ºç§æœ‰ï¼Œä¹‹å‰çš„é“¾æ¥åœ¨äº”å¤©åä¹Ÿå°±è¿‡æœŸäº†ã€‚</p>
</li>
<li>
<p><code>version</code> æ¯ 8 ä¸ªå°æ—¶è¯·æ±‚ memos è‡ªå·±çš„ API è·å–å½“å‰ memos çš„æœ€æ–°ç‰ˆæœ¬ã€‚åˆ¤æ–­ç‰ˆæœ¬è½åå¹¶ä¸”æ•°æ®åº“ä¸­ä¹‹å‰è¿˜æ²¡æœ‰è¿‡ç‰ˆæœ¬æ›´æ–°æé†’çš„è¯ï¼Œå°±æ–°å¢ä¸€æ¡ <code>Activity</code> è®°å½•ï¼Œå¹¶å°†è¯¥ <code>Activity</code> åŠ åˆ°ç®¡ç†å‘˜è´¦å·çš„ Inbox æ”¶ä»¶ç®±ä¸­ã€‚è®©ç®¡ç†å‘˜æ”¶åˆ°ç‰ˆæœ¬æ›´æ–°çš„æ¶ˆæ¯ã€‚</p>
<p>å…¶ä¸­ <code>GetLatestVersion</code> è·å–æœ€æ–°ç‰ˆæœ¬çš„å‡½æ•°ï¼Œè§£æè¯·æ±‚ä½“è¿™é‡Œï¼Œæ„Ÿè§‰å¯ä»¥è¿›ä¸€æ­¥ç²¾ç®€æˆä¸€è¡Œã€‚</p>
<p><strong>BEFORE</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>buf <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>bytes.Buffer{}
</span></span><span style="display:flex;"><span>_, err = buf.<span style="color:#d2a8ff;font-weight:bold">ReadFrom</span>(response.Body)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">&#34;&#34;</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;fail to read response body&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>version <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#a5d6ff">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err = json.<span style="color:#d2a8ff;font-weight:bold">Unmarshal</span>(buf.<span style="color:#d2a8ff;font-weight:bold">Bytes</span>(), <span style="color:#ff7b72;font-weight:bold">&amp;</span>version); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">&#34;&#34;</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;fail to unmarshal get version response&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>AFTER</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>json.<span style="color:#d2a8ff;font-weight:bold">NewDecoder</span>(response.Body).<span style="color:#d2a8ff;font-weight:bold">Decode</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>version)
</span></span></code></pre></div></li>
<li>
<p><code>memopreperty</code> æ¯ 12 å°æ—¶éå†ä¸€éæ‰€æœ‰ Payload ä¸ºç©ºçš„ memos ç¬”è®°ï¼Œä»å®ƒçš„å†…å®¹ä¸­è§£æå‡º Tagã€é“¾æ¥ã€ä»£ç å—ç­‰å±æ€§ï¼Œä¿å­˜åˆ° memos çš„ Property ä¸­ã€‚è¿™ä¸ªå‡½æ•°åœ¨åˆ›å»ºã€ä¿®æ”¹ã€æ›´æ–° MemoTag æ—¶éƒ½ä¼šè°ƒç”¨ã€‚é¢å¤–åŠ åˆ°å®šæ—¶ä»»åŠ¡ä¸­å‡ºå‘ï¼Œåº”è¯¥æ˜¯ä¸ºäº†å…œåº•ã€‚</p>
</li>
</ul>
<h2 id="gomark">gomark</h2>
<p>å¯¹äºç”¨æˆ·æ¯ä¸€ç¯‡æ–‡æœ¬ç¬”è®°ï¼Œmemos éƒ½ä¼šä½¿ç”¨ <a href="https://github.com/usememos/gomark">github.com/usememos/gomark</a> åº“æ¥åšç»“æ„åŒ–çš„è§£æã€‚å°†æ–‡æœ¬å†…å®¹è§£ææˆä¸åŒç±»å‹çš„ Go ç»“æ„ä½“å—ï¼Œä»¥å®ç°å°† Markdown æ ¼å¼è½¬çº¯æ–‡æœ¬ã€ç¬”è®° Tag æå–ç­‰åŠŸèƒ½ã€‚</p>
<p>è¿™é‡Œç®€å•æ‹†è§£ä¸€ä¸‹è¿™ä¸ªåŒ…çš„ç»“æ„å’ŒåŸç†ï¼Œæœ¬è´¨ä¸Šåˆæ˜¯æŠŠæ–‡æœ¬è¿›è¡Œè¯æ³•åˆ†æè½¬æ¢ä¸º Tokensï¼Œæ„å»º AST æŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åé€šè¿‡éå† AST å®ç°ä¸Šè¿°æåˆ°çš„åŠŸèƒ½ã€‚gomark å¥½å°±å¥½åœ¨ä»–åŠŸèƒ½ç®€å•ä½†å…¨é¢ï¼Œå¾ˆé€‚åˆåƒæˆ‘è¿™ç§ä»æ²¡å­¦è¿‡ç¼–è¯‘åŸç†çš„èœé¸¡ã€‚</p>
<p><code>parser/tokenizer/tokenizers.go</code> ä¸­å®šä¹‰äº†å„ç§ Token çš„ç±»å‹ï¼Œå¦‚ä¸‹åˆ’çº¿ã€æ˜Ÿå·ã€äº•å·ã€ç©ºæ ¼ã€æ¢è¡Œç­‰ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯åœ¨ Markdown ä¸­å«æœ‰è¯­ä¹‰æˆåˆ†çš„å­—ç¬¦ï¼Œéƒ½ä¼šä½œä¸ºä¸€ä¸ª Token ç±»å‹ã€‚æ­£æ–‡å†…å®¹åˆ†ä¸º <code>Number</code> æ•°å­—å’Œ <code>Text</code> æ–‡æœ¬ä¸¤ç§ Token ç±»å‹ã€‚</p>
<p><code>Tokenize(text string) []*Token</code> å‡½æ•°å°±æ˜¯å¾ˆæ ‡å‡†çš„ä¼ å…¥ <code>text</code> å­—ç¬¦ä¸²ï¼ŒæŒ¨ä¸ªå­—ç¬¦ switch-caseï¼Œç„¶åè½¬æ¢ä¸º Token ç»“æ„ä½“æ·»åŠ åˆ°åˆ‡ç‰‡ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> prevToken <span style="color:#ff7b72;font-weight:bold">*</span>Token
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> len(tokens) &gt; <span style="color:#a5d6ff">0</span> {
</span></span><span style="display:flex;"><span> prevToken = tokens[len(tokens)<span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#a5d6ff">1</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>isNumber <span style="color:#ff7b72;font-weight:bold">:=</span> c <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#a5d6ff">&#39;0&#39;</span> <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> c <span style="color:#ff7b72;font-weight:bold">&lt;=</span> <span style="color:#a5d6ff">&#39;9&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> prevToken <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> (prevToken.Type <span style="color:#ff7b72;font-weight:bold">==</span> Text <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> !isNumber) <span style="color:#ff7b72;font-weight:bold">||</span> (prevToken.Type <span style="color:#ff7b72;font-weight:bold">==</span> Number <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> isNumber) {
</span></span><span style="display:flex;"><span> prevToken.Value <span style="color:#ff7b72;font-weight:bold">+=</span> string(c)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">continue</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> isNumber {
</span></span><span style="display:flex;"><span> tokens = append(tokens, <span style="color:#d2a8ff;font-weight:bold">NewToken</span>(Number, string(c)))
</span></span><span style="display:flex;"><span>} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span> tokens = append(tokens, <span style="color:#d2a8ff;font-weight:bold">NewToken</span>(Text, string(c)))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯¹äºä¸åœ¨ä¸Šè¿° Markdown è¯­ä¹‰ä¸­çš„å­—ç¬¦ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­— 0-9ï¼Œå¦‚æœæ˜¯çš„è¯è¯´æ˜æ˜¯ä¸€ä¸ª <code>Number</code> æ•°å­— Tokenï¼ŒåŒæ—¶è¿˜éœ€è¦çœ‹ä¸‹ä¸Šä¸€ä¸ª Token æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯æ•°å­—ï¼Œå¦‚æœæ˜¯çš„è¯ä»–ä¿©å°±æ˜¯æŒ¨ä¸€èµ·çš„ï¼Œå…±åŒç»„æˆäº†ä¸€ä¸ª <code>Number</code> Tokenã€‚<code>Text</code> æ–‡æœ¬ Token ä¹Ÿæ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œå°†æŒ¨ç€çš„æ–‡æœ¬å­—ç¬¦ç»Ÿä¸€ä¸ºä¸€ä¸ª <code>Text</code> Tokenã€‚</p>
<p>Token æ‹†åˆ†å®Œåï¼Œå°±å¼€å§‹æ„å»º AST äº†ã€‚</p>
<p><code>ast</code> ç›®å½•ä¸‹æœ‰ <code>inline.go</code> å’Œ <code>block.go</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å‰è€…å®šä¹‰äº†å•ä¸ªèŠ‚ç‚¹ç±»å‹ï¼Œå¦‚æ™®é€šçš„æ–‡æœ¬èŠ‚ç‚¹ã€åŠ ç²—ã€æ–œä½“ã€é“¾æ¥ã€äº•å·æ ‡ç­¾ç­‰ï¼›åè€…å®šä¹‰äº†å¤šä¸ªæ™®é€šèŠ‚ç‚¹ç»„æˆçš„é›†åˆèŠ‚ç‚¹ï¼Œå¦‚æ®µè½ã€ä»£ç å—ã€æ ‡é¢˜ã€æœ‰åºæ— éœ€åˆ—è¡¨ã€å¤é€‰æ¡†ç­‰ã€‚</p>
<p><code>parser/parser.go</code> é‡Œå®šä¹‰çš„ <code>ParseXXX</code> å‡½æ•°å°†ç¬¬ä¸€æ­¥çš„ <code>[]*tokenizer.Token</code> è§£ææˆ <code>[]ast.Node</code> ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>nodes <span style="color:#ff7b72;font-weight:bold">:=</span> []ast.Node{}
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> len(tokens) &gt; <span style="color:#a5d6ff">0</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">for</span> _, blockParser <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#ff7b72">range</span> blockParsers {
</span></span><span style="display:flex;"><span> node, size <span style="color:#ff7b72;font-weight:bold">:=</span> blockParser.<span style="color:#d2a8ff;font-weight:bold">Match</span>(tokens)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> node <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> size <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#a5d6ff">0</span> {
</span></span><span style="display:flex;"><span> <span style="color:#8b949e;font-style:italic">// Consume matched tokens.</span>
</span></span><span style="display:flex;"><span> tokens = tokens[size:]
</span></span><span style="display:flex;"><span> nodes = append(nodes, node)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">break</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æœ¬è´¨ä¸Šä¹Ÿè¿˜æ˜¯å°† Tokens ä¸¢ç»™æ‰€æœ‰çš„ <code>BlockParser</code> åœ¨ for å¾ªç¯é‡Œè¿‡ä¸€éï¼Œ <code>BlockParser</code> æ¥å£å®ç° <code>Match()</code> æ–¹æ³•ï¼Œä¸åŒçš„ Node ä¼šä¸€æ¬¡æ€§è¯»å–ä¸åŒæ•°é‡çš„ Tokensï¼Œåˆ¤æ–­æ ¼å¼æ˜¯å¦æ»¡è¶³ Node çš„è¦æ±‚ï¼Œæ¥ç¡®å®šè¿™äº› Tokens æ˜¯å¦ç»„æˆäº†è¿™ä¸ª Nodeã€‚Match ä¸Šäº†åˆ™ä¼šè¿”å›ç”Ÿæˆçš„ Node å’ŒåŒ¹é…ä¸Šçš„ Tokens é•¿åº¦ï¼Œæˆªå»è¿™ä¸ª Node åŒ¹é…çš„ Tokensï¼Œå‰©ä¸‹çš„ Tokens ç»§ç»­è½®ä¸€éæ‰€æœ‰çš„ <code>BlockParser</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> defaultInlineParsers = []InlineParser{
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewEscapingCharacterParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewHTMLElementParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewBoldItalicParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewImageParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewReferencedContentParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewTagParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewStrikethroughParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewLineBreakParser</span>(),
</span></span><span style="display:flex;"><span> <span style="color:#d2a8ff;font-weight:bold">NewTextParser</span>(),
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™äº› <code>BlockParser</code> çš„é¡ºåºåº”è¯¥æ˜¯æœ‰è®²ç©¶çš„ã€‚åƒæœ€æ™®é€šçš„ã€æœ€å®¹æ˜“åŒ¹é…ä¸Šçš„ <code>Text</code> çº¯æ–‡æœ¬ç±»å‹ï¼Œåº”è¯¥æ”¾åœ¨æœ€åã€‚å½“å‰é¢æ‰€æœ‰çš„ Parser éƒ½æ²¡åŒ¹é…ä¸Šæ—¶ï¼Œæ‰è¯´æ˜è¿™ä¸ª Token æ˜¯æ–‡æœ¬ç±»å‹çš„ Nodeã€‚å¦‚æœæŠŠ <code>TextParser</code> æ”¾æœ€å‰é¢ï¼Œé‚£ä¼°è®¡æ‰€æœ‰çš„ Tokens éƒ½ä¼šè¢«åŒ¹é…æˆæ–‡æœ¬ Nodeã€‚</p>
<p>å°† Tokens è½¬æ¢ä¸º AST ä¸Šçš„ Nodes åï¼Œæœ€åè¿˜æœ‰ä¸ª <code>mergeListItemNodes</code> å‡½æ•°ï¼Œæ˜¯ç”¨æ¥ç‰¹æ®Šå¤„ç† <code>List</code> åˆ—è¡¨èŠ‚ç‚¹çš„ã€‚å¦‚åœ¨åˆ—è¡¨çš„æœ€ååŠ ä¸Šæ¢è¡Œç¬¦ï¼Œåˆ¤æ–­åˆ—è¡¨é¡¹æ˜¯è¦æ‹†æˆä¸¤ä¸ªåˆ—è¡¨èŠ‚ç‚¹è¿˜æ˜¯æ·»åŠ åˆ°æœ«å°¾ã€‚</p>
<p><code>renderer</code> ç›®å½•åˆ™æ˜¯éå†ä¸Šè¿° AST ä¸­çš„èŠ‚ç‚¹ï¼Œæ¥å°† AST è½¬æ¢æˆ HTML æˆ–è€… String çº¯æ–‡æœ¬ã€‚è¿™é‡Œå°±å¾ˆç®€å•äº†ï¼Œä¸åŒçš„èŠ‚ç‚¹è°ƒä¸åŒçš„å‡½æ•° <code>WriteString</code> å³å¯ã€‚</p>
<p>ç»¼ä¸Šï¼Œ<code>gomark</code> å°±å®Œæˆäº†å°† Markdown æ ¼å¼æ–‡æœ¬ï¼Œè§£æè½¬æ¢æˆ HTML æˆ– String çº¯æ–‡æœ¬çš„å·¥ä½œã€‚</p>
<h2 id="å…¶å®ƒçš„å°ç»†èŠ‚">å…¶å®ƒçš„å°ç»†èŠ‚</h2>
<p>æœ€åå†è¯´äº›è‡ªå·±å‘ç°çš„å°ç»†èŠ‚å§ï¼Œå°±ä¸å•ç‹¬åˆ†ä¸€å—äº†ã€‚</p>
<h3 id="å‰ç«¯-embed-indexhtml">å‰ç«¯ embed index.html</h3>
<p>éšç€ Go Embed åŠŸèƒ½åŠ å…¥åï¼Œæˆ‘å¾ˆå–œæ¬¢å°† Vue ç¼–è¯‘åçš„å‰ç«¯æ‰“åŒ…è¿› Go Binary ä¸­ã€‚å¾€å¾€æ˜¯ä¼šåœ¨ <code>web</code> æˆ–è€… <code>frontend</code> å‰ç«¯ä»£ç è·¯å¾„ä¸‹ï¼Œä¿ç•™æ”¾ç¼–è¯‘äº§ç‰©çš„ <code>dist</code> ç›®å½•ï¼Œåœ¨é‡Œé¢æ”¾ä¸ª gitkeep æ–‡ä»¶å•¥çš„ã€‚</p>
<p>memos çš„åšæ³•æ˜¯æ”¾ç½®äº†ä¸€ä¸ª <code>frontend/dist/index.html</code> æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#7ee787">html</span> lang<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#7ee787">head</span>&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#7ee787">meta</span> charset<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;UTF-8&#34;</span> /&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#7ee787">meta</span> name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;viewport&#34;</span> content<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;width=device-width, initial-scale=1.0&#34;</span> /&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#7ee787">title</span>&gt;Memos&lt;/<span style="color:#7ee787">title</span>&gt;
</span></span><span style="display:flex;"><span> &lt;/<span style="color:#7ee787">head</span>&gt;
</span></span><span style="display:flex;"><span> &lt;<span style="color:#7ee787">body</span>&gt;
</span></span><span style="display:flex;"><span> No embeddable frontend found.
</span></span><span style="display:flex;"><span> &lt;/<span style="color:#7ee787">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#7ee787">html</span>&gt;
</span></span></code></pre></div><p>ç›´æ¥åœ¨ Body ä¸­å†™æ˜äº†å‰ç«¯åµŒå…¥æ–‡ä»¶ä¸å­˜åœ¨ã€‚è¿™æ ·æ—¢å¯ä»¥é€šè¿‡ç¼–è¯‘ï¼Œå¦‚è‹¥ç”¨æˆ·è®¿é—®æ—¶ï¼Œå‰ç«¯çœŸæ²¡æœ‰è¢«æ‰“åŒ…è¿›æ¥ï¼Œåœ¨ index.html ä¹Ÿä¼šæœ‰ä¸€ä¸ªé”™è¯¯æç¤ºï¼Œæ¯”æˆ‘åªæ”¾ä¸€ä¸ªä¸ä¼šè¢«è¯»åˆ°çš„ gitkeep å¥½äº›ã€‚</p>
<h3 id="jwt-token-è§£æ">JWT Token è§£æ</h3>
<p>memos ä½¿ç”¨ JWT Token é‰´æƒã€‚å› æ­¤éœ€è¦è§£æé€šè¿‡ <code>Authorization</code> å¤´ä¼ è¿›æ¥çš„å½¢å¦‚ <code>Bearer xxxx</code> å†…å®¹ã€‚é—®é¢˜æ˜¯ç”¨æˆ·å¯èƒ½åœ¨ <code>Bearer</code> å’Œ Token ä¹‹é—´ä¼ å…¥ä¸å®šæ•°é‡çš„ç©ºæ ¼ï¼Œç”šè‡³åœ¨ <code>Bearer</code> å‰æˆ–è€… <code>xxx</code> åä¹Ÿä¼šæœ‰ç©ºæ ¼ã€‚</p>
<p>è¦æ˜¯æˆ‘çš„è¯ï¼Œå¯èƒ½å°±å…ˆ <code>strings.TrimSpace</code> ï¼Œå† <code>strings.Split</code> æŒ‰ç©ºæ ¼åˆ†éš”ï¼Œç„¶åå†å–åˆ¤æ–­é•¿åº¦ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ å’Œæœ€åä¸€ä¸ªå…ƒç´ ï¼Œå³ä¸º <code>Bearer</code> å’Œ Tokenã€‚memos é‡Œç›´æ¥ä½¿ç”¨äº† <code>strings.Fields</code> åŒ…æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œç›´æ¥è§£å†³äº†ä¸Šè¿°å¯èƒ½å­˜åœ¨çš„é—®é¢˜ã€‚åé¢è¦åšçš„ä»…ä»…åªæœ‰åˆ¤æ–­åˆ‡ç‰‡é•¿åº¦æ˜¯å¦ä¸º <code>2</code> å³å¯ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä»¥ä¸Šä¾¿æ˜¯æˆ‘ä¹‹å‰é˜…è¯» memos æºç çš„ä¸€äº›å¿ƒå¾—ä½“ä¼šã€‚ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘å¹¶æ²¡æœ‰å¾ˆä»”ç»†çš„å»é˜…è¯»æ¯ä¸€ä¸ªæ–‡ä»¶çš„æ¯ä¸€è¡Œä»£ç ï¼Œä¹Ÿæ²¡å»å®¡æ˜¯å¦æœ‰æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚memos çš„å‰ç«¯æ˜¯ä½¿ç”¨ React ç¼–å†™çš„ï¼Œç”±äºæˆ‘å¹³æ—¶ä¸æ€ä¹ˆå†™ Reactï¼Œæ‰€ä»¥å‰ç«¯è¿™å—ä¹Ÿåªæ˜¯ç²—ç•¥çš„ç¿»äº†ç¿»ã€‚</p>
<p>memos è¿˜æ˜¯æœ‰å¾ˆå¤šå¯åœˆå¯ç‚¹ä¹‹å¤„çš„ï¼Œå­¦åˆ°å¾ˆå¤šã€‚è²Œä¼¼ä½œè€…å…¶å®ƒçš„å¼€æºé¡¹ç›®ä¹Ÿéƒ½æœ‰ä½¿ç”¨ memos è¿™ç§é»‘ç™½åŠ¨ç‰©é£æ ¼çš„ Logoï¼Œç›¸å½“äºæ˜¯ä¸€å¥—ç»Ÿä¸€çš„å“ç‰Œã€‚æˆ‘å¯¹ AI ç”Ÿæˆäº§å“ Logo è¿™æ–¹é¢ä¹ŸæŒºæ„Ÿå…´è¶£çš„ï¼Œå› ä¸ºè‡ªå·±å®åœ¨è®¾è®¡ä¸æ¥ä¸€ä¸ªå¥½çœ‹çš„ Logo&hellip;&hellip; ä¹‹åè¿™å—å¯ä»¥å¤šç ”ç©¶ä¸‹ã€‚</p>