<p>ä¸Šå‘¨åƒå®Œé¥­åå»åä¼šåäº†ä¼šï¼Œå¬ Kevin è¯´åä¸ºæ‰‹ç¯å¯ä»¥å‘å®˜æ–¹æäº¤ç”³è¯·ï¼Œä»è€Œè·å¾—æ‰‹ç¯çš„æ•°æ®è®¿é—®æƒé™ã€‚ä»–è¿˜æåˆ°ä¹‹å‰å°±æœ‰ Vtuber ç›´æ’­ææ€–æ¸¸æˆæ—¶ï¼Œç”»é¢ä¸Šä¼šæ˜¾ç¤ºå®æ—¶å¿ƒç‡ä»¥å¢å¼ºèŠ‚ç›®æ•ˆæœã€‚
è¿™ç¡®å®æ˜¯ä¸ªå¾ˆ Geek å¾ˆé…·çš„ç©æ³•å“¦ï¼è¦æ˜¯æˆ‘èƒ½å°†æˆ‘çš„å®æ—¶å¿ƒç‡å±•ç¤ºåœ¨æˆ‘çš„ GitHub Profile ä¸Šï¼Œå²‚ä¸æ˜¯å¸…ç‚¸äº†ï¼</p>
<p>è¯´åšå°±åšï¼æ™šä¸Šå›åˆ°å®¿èˆåæˆ‘å¤§è‡´æœç´¢äº†ä¸‹ç›®å‰å¸‚é¢ä¸Šçš„æ‰‹ç¯ä»¥åŠå…¶äºŒå¼€çš„éš¾åº¦ï¼Œæœ€åé€‰æ‹©äº†å°ç±³æ‰‹ç¯ 6 NFC ç‰ˆã€‚
åŸä»¥ä¸ºåƒè¿™ç§æ‰‹ç¯è‡³å°‘å¾—å…«ä¹ç™¾ï¼Œæ²¡æƒ³åˆ° NFC ç‰ˆæ‰ 279ï¼ç›´æ¥äº¬ä¸œä¸‹å•ï¼
<img src="https://github.red/images/2021/06/JD_MiBand_500x.jpg" alt=""></p>
<p>ç¬¬äºŒå¤©æ—©ä¸Šå¿«é€’å°±é€åˆ°äº†ã€‚æ°é€¢å­¦æ ¡ä½“æµ‹ï¼Œæˆ‘è¯•ç€å¸¦ä¸Šæ‰‹ç¯è·‘äº† 1000 ç±³ï¼Œåœ¨å°ç±³å®˜æ–¹çš„å°ç±³è¿åŠ¨ App ä¸Šèƒ½çœ‹åˆ°å¿ƒç‡æ£€æµ‹çš„æ•ˆæœè¿˜ä¸é”™ï¼Œåªæ˜¯æˆ‘è‡ªå·±æ•£æ­¥ä¸€æ ·åœ°â€œè·‘â€äº†äº”åˆ†é’Ÿå¤ªæ‹‰èƒ¯äº†ã€‚</p>
<h2 id="æ•°æ®ä»ä½•è€Œæ¥">æ•°æ®ä»ä½•è€Œæ¥ï¼Ÿ</h2>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¥çœ‹ä¸‹æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ‹¿åˆ°å¿ƒç‡æ•°æ®å§ã€‚
é¦–å…ˆéœ€è¦æ€è€ƒçš„é—®é¢˜æ˜¯æˆ‘ä»¬çš„æ•°æ®ä»ä½•å¤„è·å¾—ã€‚å°ç±³æ‰‹ç¯ä¸æ‰‹æœºè¿æ¥æ—¶ï¼Œä¼šå°†ç›¸å…³ä¿¡æ¯åŒæ­¥è‡³å°ç±³è¿åŠ¨ Appï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥å¯¹è¿™ä¸ª App æŠ“ä¸ªåŒ…æ‹¿åˆ°æ¥å£ï¼Œè¯·æ±‚å°ç±³çš„æœåŠ¡å™¨è·å–æˆ‘ä»¬çš„æ•°æ®ã€‚ä½†è¿™ç»•äº†æ•´æ•´ä¸€åœˆå¯å¤ªéº»çƒ¦äº†ï¼Œæ‰‹ç¯å°±æˆ´åœ¨æˆ‘æ‰‹ä¸Šï¼Œä¸ºä½•ä¸ç›´æ¥é€šè¿‡è“ç‰™è¿æ¥æ‰‹ç¯è¯»å–æ•°æ®å‘¢ï¼Ÿ
è¿™å°±æ˜¯æˆ‘çš„æ€è·¯ï¼Œæˆ‘æƒ³ç›´æ¥åœ¨é€šè¿‡è“ç‰™åè®®ä¸å°ç±³æ‰‹ç¯è¿›è¡Œé€šä¿¡ï¼Œè·å–çœŸæ­£çš„â€œä¸€æ‰‹æ•°æ®â€ã€‚
è€ƒè™‘åˆ°ä½¿ç”¨ iPhone ä¸æ‰‹ç¯å»ºç«‹é•¿è¿æ¥é€šä¿¡çš„è¯ï¼ŒiOS åº”ç”¨ä¿æ´»æ–¹é¢ä¼°è®¡ä¼šæœ‰ä¸€å †éº»çƒ¦äº‹ï¼Œå†µä¸”å†™ Swift ä¸å¦‚è®©æˆ‘å»æ­»ã€‚ä¸å¦‚ç›´æ¥åœ¨ MacBook ä¸Šè·‘ä¸ªåå°è¿›ç¨‹ä¸€ç›´ç”¨è“ç‰™ä¸æ‰‹ç¯äº¤äº’æ¥çš„æ–¹ä¾¿ã€‚åæ­£æˆ‘ Mac ä¹ŸåŸºæœ¬æ˜¯éšèº«å¸¦çš„ã€‚ğŸ˜</p>
<h2 id="è·å–å°ç±³æ‰‹ç¯-auth-key">è·å–å°ç±³æ‰‹ç¯ Auth Key</h2>
<p>å¿ƒç‡ä¿¡æ¯å¹¶ä¸åƒè®¾å¤‡çš„ç”µæ± ç”µé‡ã€æ—¶é—´ä¿¡æ¯ç­‰ç›´æ¥å°±èƒ½è·å¾—ï¼Œåœ¨é€šè¿‡è“ç‰™è·å–å°ç±³æ‰‹ç¯çš„å¿ƒç‡ä¿¡æ¯ä¹‹å‰ï¼Œæ˜¯éœ€è¦å…ˆä¸æ‰‹ç¯è¿›è¡ŒéªŒè¯çš„ã€‚
éªŒè¯çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‘å°ç±³æ‰‹ç¯è¯·æ±‚ä¸€ä¸ªéšæœºæ•°ã€‚</li>
<li>æ¥æ”¶åˆ°éšæœºæ•°åï¼Œä½¿ç”¨è¯¥æ‰‹ç¯çš„ Auth Key å¯¹éšæœºæ•°è¿›è¡Œ AES å¯¹ç§°åŠ å¯†ã€‚</li>
<li>å°†åŠ å¯†åçš„ä¿¡æ¯å‘å›ç»™æ‰‹ç¯ã€‚</li>
<li>éªŒè¯é€šè¿‡ã€‚</li>
</ol>
<p>å¯¹äº Android æ‰‹æœºè€Œè¨€ï¼Œè·å– Auth Key çš„æ–¹æ³•ååˆ†ç®€å•ï¼ˆå¤§æ¦‚ï¼‰ï¼š
è®¿é—®è¿™ä¸ªç½‘ç«™ï¼š<a href="http://www.freemyband.com/">http://www.freemyband.com/</a> å¹¶æ ¹æ®é¡µé¢ä¸Šçš„æŒ‡å¼•ï¼Œä¸‹è½½ä¸€ä¸ªé­”æ”¹è¿‡çš„å°ç±³è¿åŠ¨ Appï¼Œæ‰“å¼€åä¸æ‰‹ç¯é…å¯¹ï¼Œä¹‹åå°±å¯ä»¥åœ¨æ‰‹æœº <code>/sdcard/freemyband</code> ç›®å½•è·å–åˆ°æ‰‹ç¯çš„ Auth Keyã€‚</p>
<p>å¯æƒœæˆ‘çš„è€æ—§å®‰å“æœºååˆ†çš„åƒåœ¾ï¼Œå®ƒçš„é…ç½®è·‘ä¸èµ·æ¥ä¸Šæ–‡ä¸­æåˆ°çš„ Appï¼Œå› æ­¤ä»¥ä¸Šæ­¥éª¤æˆ‘å¹¶æœªå®é™…æµ‹è¯•è¿‡ã€‚æœ€åæˆ‘æ˜¯ä½¿ç”¨ä¸€å°è¶Šç‹±çš„ iPad è¿›è¡Œæ“ä½œã€‚
æˆ‘åœ¨ iPad ä¸Šå®‰è£…å¥½å°ç±³è¿åŠ¨çš„ Appï¼Œä¸å°ç±³æ‰‹ç¯æˆåŠŸé…å¯¹åã€‚SSH è¿ä¸Š iPadï¼Œåœ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/var/mobile/Containers/Data/Application/&lt;MiFit_App_UUID&gt;/Documents
</span></span></code></pre></div><p>ç›®å½•ä¸‹æ‰¾åˆ°äº† <code>HMDBDeviceInfoDataBaseV2.sqlite</code> è¿™æ ·ä¸€ä¸ª SQLite æ•°æ®åº“ï¼Œ<code>scp</code> å°†å…¶æ‹–åˆ°ç”µè„‘ä¸Šæ‰“å¼€ï¼Œåœ¨ <code>device_info</code> è¡¨çš„ <code>deviceOAuthKey</code> å­—æ®µä¸­è·å–åˆ°äº†æ‰‹ç¯çš„ Auth Keyã€‚</p>
<p><img src="https://github.red/images/2021/06/MiFit_SQLite.png" alt=""></p>
<p>è¯¥ Auth Key åœ¨è®¾å¤‡æ¢å¤å‡ºäº§è®¾ç½®åæ‰ä¼šæ”¹å˜ï¼Œå› æ­¤ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ‹¿åˆ°è¿‡ä¸€æ¬¡è®°ä¸‹æ¥å³å¯ã€‚</p>
<h2 id="æ£€æµ‹ç”µè„‘è“ç‰™æ˜¯å¦æ­£å¸¸">æ£€æµ‹ç”µè„‘è“ç‰™æ˜¯å¦æ­£å¸¸</h2>
<p>ç°åœ¨è®©æˆ‘ä»¬æ¥è¯•è¯•é€šè¿‡ MacBook çš„è“ç‰™ä¸å°ç±³æ‰‹ç¯è¿›è¡Œé€šä¿¡ã€‚åœ¨ä½¿ç”¨ Go ç¼–å†™çœŸæ­£çš„ä»£ç å‰ï¼Œæˆ‘ä»¬å¾—å…ˆæµ‹è¯•ä¸‹ Mac çš„è“ç‰™ï¼Œå…å¾—åé¢è°ƒè¯•äº†åŠå¤©ä»£ç æœ€åå‘ç°æ˜¯ç”µè„‘è¿ä¸ä¸Šå°ç±³æ‰‹ç¯ã€‚
è¿™é‡Œæ¨èä½¿ç”¨ Bluetility æ¥è¿›è¡Œæµ‹è¯•ï¼šhttps://github.com/jnross/Bluetility ç›´æ¥ç»ˆç«¯è¿è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install --cask bluetility
</span></span></code></pre></div><p>å®‰è£…æˆåŠŸåæ‰“å¼€ Appï¼Œä½ ä¼šåœ¨æœ€å³ä¾§çš„ Devices åˆ—è¡¨ä¸­çœ‹åˆ°é™„ä»¶å‘ç°çš„è“ç‰™è®¾å¤‡ã€‚æ‰¾åˆ°å¹¶ç‚¹å‡»ä½ çš„å°ç±³æ‰‹ç¯ï¼ˆæˆ‘çš„æ˜¯ <code>Mi Smart Band 6</code>ï¼‰ï¼›å³ä¾§ Services ä¼šå‡ºæ¥ä¸€åˆ—ï¼Œç‚¹å‡» <code>Battery</code>ï¼›å†åœ¨ <code>Characteristics</code> ä¸­ç‚¹å‡» <code>Battery Level</code>ï¼Œè¿™æ—¶ä¾¿è¯»å–åˆ°äº†è¿™ä¸ª <code>Characteristics</code> çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨è¯¥æ•°æ®è½¬æ¢ä¸ºåè¿›åˆ¶æ—¶çš„ç»“æœï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>100</code>ï¼Œå³å½“å‰æ‰‹ç¯ç”µé‡ä¸º 100%ã€‚</p>
<p><img src="https://github.red/images/2021/06/Bluetility.png" alt=""></p>
<p>å¥½ï¼è¿™è¯´æ˜æˆ‘ä»¬çš„è“ç‰™æ²¡æœ‰é—®é¢˜ï¼Œä¸‹é¢å°±æ˜¯å¼€å§‹å†™ä»£ç äº†ï¼</p>
<h2 id="å°è¯•ç‰›åˆ€è·å–ç”µé‡ä¿¡æ¯">å°è¯•ç‰›åˆ€ï¼šè·å–ç”µé‡ä¿¡æ¯</h2>
<p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ª Go çš„ BLE (Bluetooh Low Energy) åº“ï¼Œä»è€Œå®ç°ä¸è“ç‰™è®¾å¤‡çš„é€šä¿¡ã€‚åœ¨ GitHub ä¸Šç®€å•çš„æœç´¢è¿‡åï¼Œä½ å¯èƒ½å¾ˆè½»æ˜“çš„å°±å‘ç°äº† <code>github.com/go-ble/ble</code> è¿™ä¹ˆä¸€ä¸ªåº“ã€‚
<div class="box-warning box"><i class="box-icon-warning"></i> <b>æœ‰å‘æ³¨æ„</b><br> github.com/go-ble/ble å·²ä¸å†å¯¹ macOS å¹³å°è¿›è¡Œç»´æŠ¤ï¼Œä»¥è‡³äºä½ åœ¨ macOS ä¸‹ä½¿ç”¨è¯¥åº“è¿ä»£ç ç¼–è¯‘éƒ½ä¸é€šè¿‡ï¼ </div>
</p>
<p>ä¸è¿‡æˆ‘çœ‹åˆ°è¿™ä¸ªåº“æœ‰ä¸å°‘çš„ Forkï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ Find useful forks çœ‹ä¸€ä¸‹ï¼š<a href="https://useful-forks.github.io/?repo=go-ble%2Fble">https://useful-forks.github.io/?repo=go-ble%2Fble</a> ï¼Œå…¶ä¸­ star æ•°æ’åç¬¬äºŒçš„ Fork <code>github.com/JuulLabs-OSS/ble</code> å¢åŠ äº†å¯¹ macOS Mojave ä¸ Catalina çš„æ”¯æŒï¼Œæˆ‘ä»¬æœ€åç”¨çš„å°±æ˜¯å®ƒï¼</p>
<h3 id="è®¾ç½®è“ç‰™è®¾å¤‡">è®¾ç½®è“ç‰™è®¾å¤‡</h3>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦è®¾ç½®å¥½æˆ‘ä»¬ MacBook æœ¬æœºçš„è“ç‰™è®¾å¤‡ï¼Œè¿™é‡Œå…¨éƒ¨ä½¿ç”¨é»˜è®¤çš„å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>d, err <span style="color:#ff7b72;font-weight:bold">:=</span> darwin.<span style="color:#d2a8ff;font-weight:bold">NewDevice</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;new device&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ble.<span style="color:#d2a8ff;font-weight:bold">SetDefaultDevice</span>(d)
</span></span></code></pre></div><h3 id="å‘ç°é™„è¿‘çš„è“ç‰™è®¾å¤‡å¹¶è¿æ¥">å‘ç°é™„è¿‘çš„è“ç‰™è®¾å¤‡å¹¶è¿æ¥</h3>
<p>è®¾ç½®å¥½è“ç‰™è®¾å¤‡åï¼Œä¹‹åä»£ç çš„æµç¨‹ä¸ä¸Šè¿°ä½¿ç”¨ Bluetility App çš„æ“ä½œæµç¨‹å…¶å®æ˜¯ä¸€æ ·çš„ã€‚
æˆ‘ä»¬éœ€è¦å‘ç°é™„è¿‘çš„è“ç‰™è®¾å¤‡ï¼Œ<code>ble.Connect</code> æ–¹æ³•ä¼šåœ¨å‘ç°æ–°çš„è®¾å¤‡æ—¶è°ƒç”¨å…¶ä¸­çš„åŒ¿åå‡½æ•°ï¼Œå…¥å‚ä¸ºè®¾å¤‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬é€šè¿‡è®¾å¤‡ä¿¡æ¯ï¼ˆè®¾å¤‡åã€è®¾å¤‡ UUIDï¼‰ç­‰æ¥åˆ¤æ–­è¿™æ˜¯å¦æ˜¯æˆ‘ä»¬æƒ³è¦è¿æ¥çš„ç›®æ ‡è®¾å¤‡ï¼Œå¦‚æœç¡®è®¤è¿æ¥åˆ™è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚
ä¸‹é¢çš„ä»£ç ä¸€ç›´è¿”å› <code>false</code>ï¼Œå¹¶å°†å‘ç°çš„è®¾å¤‡ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œä½ å¯ä»¥åœ¨æ‰“å°å‡ºçš„è®¾å¤‡ä¿¡æ¯ä¸­æ‰¾åˆ°è‡ªå·±å°ç±³æ‰‹ç¯çš„ç‰¹å¾ã€‚è¿™é‡Œæˆ‘å»ºè®®è¿˜æ˜¯ä½¿ç”¨ <code>a.Addr()</code> è¿™ä¸ªå€¼è¾¨åˆ«è®¾å¤‡æ¯”è¾ƒç¨³å¥ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>ctx <span style="color:#ff7b72;font-weight:bold">:=</span> context.<span style="color:#d2a8ff;font-weight:bold">Background</span>()
</span></span><span style="display:flex;"><span>client, _ <span style="color:#ff7b72;font-weight:bold">:=</span> ble.<span style="color:#d2a8ff;font-weight:bold">Connect</span>(ctx, <span style="color:#ff7b72">func</span>(a ble.Advertisement) <span style="color:#ff7b72">bool</span> {
</span></span><span style="display:flex;"><span> fmt.<span style="color:#d2a8ff;font-weight:bold">Printf</span>(<span style="color:#a5d6ff">&#34;%s - %s\n&#34;</span>, a.<span style="color:#d2a8ff;font-weight:bold">LocalName</span>(), a.<span style="color:#d2a8ff;font-weight:bold">Addr</span>().<span style="color:#d2a8ff;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">false</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h3 id="å‘ç°è®¾å¤‡-services">å‘ç°è®¾å¤‡ Services</h3>
<p>åœ¨ä½¿ç”¨ Bluetility App è·å–è®¾å¤‡ç”µé‡æ—¶ï¼Œæˆ‘ä»¬æœ€ç»ˆé€šè¿‡è¯»å– <code>Characteristics</code> ä¸­çš„æ•°æ®è·å–åˆ°è®¾å¤‡çš„ç”µé‡ä¿¡æ¯ï¼Œé‚£ç°åœ¨é€šè¿‡ <code>ble</code> åº“è¿ä¸Šäº†è®¾å¤‡ï¼Œæˆ‘å‘ç°å…¶ <code>Client</code> ä¸‹å°±æœ‰ <code>ReadCharacteristic()</code>ï¼Œé‚£ä¹ˆæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ä¼ å…¥ <code>Characteristics</code> çš„ UUID å»è¯»ç”µé‡äº†å‘¢ï¼Ÿ
ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬çš„æ“ä½œéœ€è¦ä¸€æ­¥æ­¥æ¥ã€‚ä¸ä½¿ç”¨ Bluetility App å›¾å½¢åŒ–æ“ä½œä¸€è‡´ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå‘ç°è®¾å¤‡ä¸‹æ‰€æœ‰çš„ Servicesï¼Œå†å»å‘ç° <code>Service</code> ä¸‹çš„ <code>Characteristics</code>ï¼Œè¿™æ—¶æ‰èƒ½è¯»å–å¯¹åº” <code>Characteristics</code> ä¸­çš„æ•°æ®ã€‚
å‘ç° Services çš„ä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦è®¾ç½®è¿‡æ»¤æ¡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>services, err <span style="color:#ff7b72;font-weight:bold">:=</span> client.<span style="color:#d2a8ff;font-weight:bold">DiscoverServices</span>(<span style="color:#79c0ff">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;discover services&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="æ‰¾åˆ°-battery-service">æ‰¾åˆ° Battery Service</h3>
<p>æ ¹æ® Bluetooth GATTï¼Œå…¨å¤©ä¸‹è“ç‰™è®¾å¤‡çš„ç”µæ± ç”µé‡éƒ½ä» UUID ä¸º <code>0000180f-0000-1000-8000-00805f9b34fb</code> çš„ Service ä¸­è·å–ã€‚æˆ‘ä»¬å¯¹ä¸Šé¢çš„ <code>services</code> è¿›è¡Œéå†ï¼Œè·å–åˆ° UUID ä¸º <code>180f</code> çš„ Serviceï¼Œå³ä¸ºç”µæ± ç”µé‡ Battery Serviceã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">for</span> _, service <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#ff7b72">range</span> services {
</span></span><span style="display:flex;"><span> service <span style="color:#ff7b72;font-weight:bold">:=</span> service
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;180f&#34;</span>: <span style="color:#8b949e;font-style:italic">// Battery</span>
</span></span><span style="display:flex;"><span> miband.battery = service
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="æ‰¾åˆ°-battery-characteristic">æ‰¾åˆ° Battery Characteristic</h3>
<p>åŒç†ï¼Œæˆ‘ä»¬å†å¯»æ‰¾ Battery Service ä¸‹çš„æ‰€æœ‰çš„ Characteristicsã€‚éå†è·å–åˆ°çš„ <code>characteristics</code>ï¼Œæ‰¾åˆ° UUID ä¸º <code>2a19</code> çš„ Characteristicã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>characteristics, err = client.<span style="color:#d2a8ff;font-weight:bold">DiscoverCharacteristics</span>(<span style="color:#79c0ff">nil</span>, miband.battery)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">nil</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;discover battery service characteristics&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> _, characteristic <span style="color:#ff7b72;font-weight:bold">:=</span> <span style="color:#ff7b72">range</span> characteristics {
</span></span><span style="display:flex;"><span> characteristic <span style="color:#ff7b72;font-weight:bold">:=</span> characteristic
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> characteristic.UUID.<span style="color:#d2a8ff;font-weight:bold">String</span>() <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">&#34;2a19&#34;</span> {
</span></span><span style="display:flex;"><span> miband.batteryCharacteristic = characteristic
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="è¯»å–ç”µæ± ç”µé‡ä¿¡æ¯">è¯»å–ç”µæ± ç”µé‡ä¿¡æ¯</h3>
<p>ç»ˆäºï¼Œåœ¨è¿™ä¹ˆä¸€ç¯å¥—ä¸€ç¯ä¹‹åï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†è¿™ä¸ª Characteristicï¼Œè¿™æ—¶æ‰èƒ½å¤Ÿä½¿ç”¨ <code>ReadCharacteristic()</code> æ–¹æ³•æ¥è¯»å–å…¶ä¸­çš„å†…å®¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>data, err <span style="color:#ff7b72;font-weight:bold">:=</span> m.client.<span style="color:#d2a8ff;font-weight:bold">ReadCharacteristic</span>(m.batteryCharacteristic)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>, errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;read characteristic&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">return</span> int(data[<span style="color:#a5d6ff">0</span>]), <span style="color:#79c0ff">nil</span>
</span></span></code></pre></div><p>å°†è¿”å›çš„æ•°æ®ä¸­çš„ç¬¬ä¸€ä¸ª byte è½¬æ¢ä¸ºåè¿›åˆ¶ï¼Œè¿™å°±æ˜¯å°ç±³æ‰‹ç¯çš„ç”µæ± ç”µé‡äº†ï¼
è‡³æ­¤ï¼Œä½ å·²ç»å­¦ä¼šäº†ä» Device -&gt; Service -&gt; Characteristic çš„è¿‡ç¨‹ï¼Œå¹¶æˆåŠŸè¯»å–åˆ°äº† Characteristic ä¸­çš„æ•°æ®ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æ¥è·å–å¿ƒç‡ä¿¡æ¯å§~ï¼ˆç¬‘ï¼‰</p>
<h2 id="ä½¿ç”¨-auth-key-è¿›è¡ŒéªŒè¯">ä½¿ç”¨ Auth Key è¿›è¡ŒéªŒè¯</h2>
<p>è¿˜è®°å¾—ä¸Šæ–‡ä¸­æˆ‘ä»¬è·å–åˆ°çš„å°ç±³æ‰‹ç¯ Auth Key å—ï¼Ÿç°åœ¨æˆ‘ä»¬è¦ä½¿ç”¨å®ƒæ¥è¿›è¡ŒéªŒè¯ã€‚
ä¸‹æ–‡ä¸­çš„äº¤äº’å‚è€ƒè‡ªå‰äººçš„å°ç±³æ‰‹ç¯é€šä¿¡ Python å®ç°ï¼š<a href="https://sourcegraph.com/github.com/satcar77/miband4@master/-/blob/miband.py">https://sourcegraph.com/github.com/satcar77/miband4@master/-/blob/miband.py</a> æˆ‘åªæ˜¯åœ¨è¿™åŸºç¡€ä¸Šç”¨ Go é‡å†™äº†ä¸€éï¼Œåšäº†ç‚¹å¾®å°çš„è´¡çŒ®ã€‚ğŸ˜Š</p>
<p>å‚ç…§ä¸Šæ–‡è¿‡ç¨‹ï¼Œè·å–åˆ° NotifyService (UUID: <code>fee1</code>) ä»¥åŠå…¶ä¸‹çš„ AuthCharacteristic (UUID: <code>000000090000351221180009af100700</code>)ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ AuthCharacteristic æ¥è¿›è¡ŒéªŒè¯çš„é€šä¿¡ã€‚</p>
<ol>
<li>æ³¨å†Œ Notification Handler
å› ä¸ºè“ç‰™çš„å‘é€ä¸æ¥æ”¶æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ Subscribe æ¥è‡ªå°ç±³æ‰‹ç¯ Characteristic ä¼ å›çš„æ¶ˆæ¯ï¼Œæ ¹æ®è¿”å›çš„æ¶ˆæ¯åšä¸‹ä¸€æ­¥å¤„ç†ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>err = client.<span style="color:#d2a8ff;font-weight:bold">Subscribe</span>(miband.authCharacteristic, <span style="color:#79c0ff">false</span>, miband.handleAuthNotification)
</span></span></code></pre></div><p><code>handleAuthNotification</code> æ–¹æ³•å¦‚ä¸‹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¤§å¤§çš„ switch-caseï¼Œå¯¹è¿”å›æ¶ˆæ¯çš„å‰ä¸‰ä½è¿›è¡Œåˆ¤æ–­ï¼Œä»è€Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span> (m <span style="color:#ff7b72;font-weight:bold">*</span>MiBand) <span style="color:#d2a8ff;font-weight:bold">handleAuthNotification</span>(data []<span style="color:#ff7b72">byte</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">switch</span> string(data[:<span style="color:#a5d6ff">3</span>]) {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x01\x01&#34;</span>:
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Trace</span>(<span style="color:#a5d6ff">&#34;[Auth] Start to request random number...&#34;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> m.<span style="color:#d2a8ff;font-weight:bold">requestRandomNumber</span>(); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Failed to request random number: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x01\x04&#34;</span>:
</span></span><span style="display:flex;"><span> m.state = AuthKeySendingFailed
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Failed to send key.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x02\x01&#34;</span>:
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Trace</span>(<span style="color:#a5d6ff">&#34;[Auth] Start to send encrypt random number...&#34;</span>)
</span></span><span style="display:flex;"><span> randomNumber <span style="color:#ff7b72;font-weight:bold">:=</span> data[<span style="color:#a5d6ff">3</span>:]
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">:=</span> m.<span style="color:#d2a8ff;font-weight:bold">sendEncryptRandomNumber</span>(randomNumber); err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Failed to send encrypt random number: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x02\x04&#34;</span>:
</span></span><span style="display:flex;"><span> m.state = AuthRequestRandomNumberError
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Failed to request random number.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x03\x01&#34;</span>:
</span></span><span style="display:flex;"><span> m.state = AuthSuccess
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Trace</span>(<span style="color:#a5d6ff">&#34;[Auth] Success!&#34;</span>)
</span></span><span style="display:flex;"><span> close(m.authed)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">case</span> <span style="color:#a5d6ff">&#34;\x10\x03\x04&#34;</span>:
</span></span><span style="display:flex;"><span> m.state = AuthEncryptionKeyFailed
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Encryption key auth fail, sending new key...&#34;</span>)
</span></span><span style="display:flex;"><span> err <span style="color:#ff7b72;font-weight:bold">:=</span> m.<span style="color:#d2a8ff;font-weight:bold">sendKey</span>()
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;[Auth] Failed to send new key: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">default</span>:
</span></span><span style="display:flex;"><span> m.state = AuthFailed
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;Auth failed: %v&#34;</span>, data[:<span style="color:#a5d6ff">3</span>])
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="2">
<li>å‘ AuthCharacteristic å‘é€ <code>\x02\x00</code>ã€‚
æˆ‘ä»¬å…ˆä¸»åŠ¨å‘é€ <code>\x02\00</code>ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>miband.client.<span style="color:#d2a8ff;font-weight:bold">WriteCharacteristic</span>(miband.authCharacteristic, []byte(<span style="color:#a5d6ff">&#34;\x02\x00&#34;</span>), <span style="color:#79c0ff">false</span>)
</span></span></code></pre></div><p>ä¹‹åä¼šæ”¶åˆ°æ¥è‡ªå°ç±³æ‰‹ç¯çš„ä»¥ <code>\x10\x02\x01</code> å¼€å¤´çš„æ¶ˆæ¯ï¼Œå‰ä¸‰ä½ä¹‹åçš„æ¶ˆæ¯å³ä¸ºè¿”å›éšæœºæ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ Auth Key å¯¹è¿™ä¸ªéšæœºæ•°è¿›è¡Œ AES åŠ å¯†åå‘å›ç»™å°ç±³æ‰‹ç¯ã€‚
è¿™æ—¶è‹¥ Auth Key éªŒè¯æˆåŠŸï¼Œå°†æ”¶åˆ° <code>\x10\x03\x01</code> å¼€å¤´çš„æ¶ˆæ¯ï¼Œè‡³æ­¤æ•´ä¸ªéªŒè¯ç»“æŸã€‚</p>
<div class="box-warning box"><i class="box-icon-warning"></i> <b>æœ‰å‘æ³¨æ„</b><br> Go çš„ crypto æ ‡å‡†åº“ä¸­ä¸å¸¦ AES ECB æ¨¡å¼çš„åŠ å¯†ï¼Œæ›¾æœ‰äººå‘ crypto æºç æäº¤è¿‡æ”¯æŒ AES ECB æ¨¡å¼çš„ Pull Requestsï¼Œä½†è¢« Cox å› è¯¥åŠ å¯†æ¨¡å¼ä¸å®‰å…¨ç»™æ‹’ç»äº†ã€‚å› æ­¤æˆ‘è¿™é‡Œå¾ˆæŠ•æœºå–å·§åœ°å°†å½“æ—¶è¢«æ‹’æ‰çš„ä»£ç ç›´æ¥å¤åˆ¶è¿‡æ¥ä½¿ç”¨äº†ã€‚ä»£ç è§ï¼šhttps://github.com/wuhan005/mebeats/blob/master/cryptoutil/aes.go </div>
<h2 id="è·å–å®æ—¶å¿ƒç‡ä¿¡æ¯">è·å–å®æ—¶å¿ƒç‡ä¿¡æ¯</h2>
<h3 id="å‘ç°-servicecharacteristic">å‘ç° Serviceã€Characteristic</h3>
<p>ä¸ä¸Šè¿°æ“ä½œç›¸åŒï¼Œæˆ‘ä»¬éœ€è¦å…ˆ Discover åˆ°ç›¸åº”çš„ Service ä»¥åŠ Service ä¸‹çš„ Characteristicã€‚
å®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>HeartRate Service (UUID: <code>180d</code>)</li>
<li>HeartRate Control Characteristic (UUID: <code>2a39</code>) ç”¨äºæ§åˆ¶å¿ƒç‡æ¨¡å—ï¼Œå¦‚å¼€å§‹ä¸€æ¬¡å¿ƒç‡æ£€æµ‹ï¼Œè®¾ç½®è‡ªåŠ¨å¿ƒç‡æ£€æµ‹é¢‘ç‡ç­‰</li>
<li>HeartRate Measure Characteristic (UUID: <code>2a37</code>) è®¢é˜…è¯¥ Characteristic ä»¥æ¥æ”¶è®¾å¤‡å‘é€çš„å¿ƒç‡ä¿¡æ¯</li>
</ul>
<h3 id="è®¢é˜…-measure-characteristic">è®¢é˜… Measure Characteristic</h3>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>err <span style="color:#ff7b72;font-weight:bold">:=</span> m.client.<span style="color:#d2a8ff;font-weight:bold">Subscribe</span>(m.heartRateMeasureCharacteristic, <span style="color:#79c0ff">false</span>, m.handleHeartRateNotification)
</span></span></code></pre></div><p>è¿™ä¸ª Characteristic è¿”å›çš„å†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯å¿ƒç‡ä¿¡æ¯ï¼Œæˆ‘ä»¬å–ç¬¬äºŒä¸ª byteï¼Œè½¬ä¸ºåè¿›åˆ¶å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span> (m <span style="color:#ff7b72;font-weight:bold">*</span>MiBand) <span style="color:#d2a8ff;font-weight:bold">handleHeartRateNotification</span>(data []<span style="color:#ff7b72">byte</span>) {
</span></span><span style="display:flex;"><span> m.currentHeartRate = int(data[<span style="color:#a5d6ff">1</span>])
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Trace</span>(<span style="color:#a5d6ff">&#34;Heart rate: %d&#34;</span>, m.currentHeartRate)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å¼€å¯å®æ—¶å¿ƒç‡è·å–">å¼€å¯å®æ—¶å¿ƒç‡è·å–</h3>
<p>è¿™é‡Œæ˜¯å‘ HeartRate Control Characteristic å‘é€æ¶ˆæ¯ï¼Œé¦–å…ˆæ˜¯åœæ­¢ä¹‹å‰æ­£åœ¨è¿›è¡Œçš„è‡ªåŠ¨ä¸æ‰‹åŠ¨å¿ƒè·³æ£€æµ‹ï¼Œå†å¼€å¯ä¸€æ¬¡æ‰‹åŠ¨å¿ƒè·³æ£€æµ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Stop continuous.</span>
</span></span><span style="display:flex;"><span>err = m.client.<span style="color:#d2a8ff;font-weight:bold">WriteCharacteristic</span>(m.heartRateControlCharacteristic, []byte(<span style="color:#a5d6ff">&#34;\x15\x02\x00&#34;</span>), <span style="color:#79c0ff">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;stop continuous&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Stop manual.</span>
</span></span><span style="display:flex;"><span>err = m.client.<span style="color:#d2a8ff;font-weight:bold">WriteCharacteristic</span>(m.heartRateControlCharacteristic, []byte(<span style="color:#a5d6ff">&#34;\x15\x01\x00&#34;</span>), <span style="color:#79c0ff">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;stop manual&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Start manual.</span>
</span></span><span style="display:flex;"><span>err = m.client.<span style="color:#d2a8ff;font-weight:bold">WriteCharacteristic</span>(m.heartRateControlCharacteristic, []byte(<span style="color:#a5d6ff">&#34;\x15\x01\x01&#34;</span>), <span style="color:#79c0ff">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">return</span> errors.<span style="color:#d2a8ff;font-weight:bold">Wrap</span>(err, <span style="color:#a5d6ff">&#34;start manual&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">go</span> <span style="color:#ff7b72">func</span>() {
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">for</span> {
</span></span><span style="display:flex;"><span> time.<span style="color:#d2a8ff;font-weight:bold">Sleep</span>(<span style="color:#a5d6ff">12</span> <span style="color:#ff7b72;font-weight:bold">*</span> time.Second)
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Trace</span>(<span style="color:#a5d6ff">&#34;Send ping...&#34;</span>)
</span></span><span style="display:flex;"><span> err = m.client.<span style="color:#d2a8ff;font-weight:bold">WriteCharacteristic</span>(m.heartRateControlCharacteristic, []byte(<span style="color:#a5d6ff">&#34;\x16&#34;</span>), <span style="color:#79c0ff">false</span>)
</span></span><span style="display:flex;"><span> <span style="color:#ff7b72">if</span> err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#79c0ff">nil</span> {
</span></span><span style="display:flex;"><span> log.<span style="color:#d2a8ff;font-weight:bold">Error</span>(<span style="color:#a5d6ff">&#34;Failed to send ping: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬ä»…å‘é€ä¸Šè¿°çš„ä¸‰ä¸ªæ¶ˆæ¯ï¼Œé‚£ä¹ˆåœ¨ä¸€å¼€å§‹çš„åå‡ ç§’å†…ï¼Œæ¯éš”å››äº”ç§’æˆ‘ä»¬å°±èƒ½æ”¶åˆ°ä¸€æ¬¡å¿ƒç‡ä¿¡æ¯ï¼Œåœ¨ä¹‹åä¼šå˜æˆä¸€åˆ†é’Ÿæ‰æ”¶åˆ°ä¸€æ¬¡ã€‚å› æ­¤æˆ‘èµ·äº†ä¸ªåç¨‹ï¼Œæ¯éš” 12 ç§’ ping ä¸€ä¸‹ã€‚è¿™æ ·å°±èƒ½åœ¨çŸ­é—´éš”å†…ä¸æ–­æ”¶åˆ°æ–°çš„å¿ƒç‡æ•°æ®äº†ã€‚</p>
<p>è‡³äºè¿™æ•°æ®èƒ½æ€æ ·ç©å‡ºèŠ±æ¥ï¼Œé‚£å°±çœ‹å„ä½çš„æƒ³è±¡åŠ›äº†ã€‚</p>
<h2 id="æœ€åè¯´å‡ å¥">æœ€åè¯´å‡ å¥</h2>
<p>è¿™ä¸ªé¡¹ç›®çš„å®Œæ•´ä»£ç è§ï¼š<a href="https://github.com/wuhan005/mebeats">https://github.com/wuhan005/mebeats</a> ï¼Œç°åœ¨ä½ ä¹Ÿå¯ä»¥åœ¨æˆ‘çš„ GitHub Profile çœ‹åˆ°æˆ‘çš„å®æ—¶å¿ƒè·³äº†ğŸ’“ï¼
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç«¯è¿”å›å›¾ç‰‡æ—¶è®°å¾—åŠ ä¸Šè¿™ä¸ªå“åº”å¤´ï¼Œè¿™æ · GitHub æ‰ä¸ä¼šç¼“å­˜è¿™å¼ å›¾ç‰‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#f85149">cache-control: no-cache,max-age=0,no-store,s-maxage=0,proxy-revalidate
</span></span></span></code></pre></div><p>é¡¹ç›®çš„åç«¯ä½¿ç”¨çš„æ˜¯ Flamego æ¡†æ¶ï¼Œè™½ç„¶å¥¹ç°åœ¨è¿˜ä¸æ˜¯å¾ˆå®Œå¤‡ï¼Œä½†è¿˜æ˜¯å¾ˆå¸Œæœ›å¤§å®¶éƒ½å»ä½“éªŒä¸‹ã€‚</p>
<p>å‘¨äºŒçš„æ—¶å€™æˆ‘å‘äº†æ¡ Twitter ä»‹ç»äº†ä¸‹è¿™ä¸ªé¡¹ç›®ï¼Œè¢«å¤§ä½¬è½¬å‘åæ²¡æƒ³åˆ°å±…ç„¶ç«äº†ã€‚ğŸ”¥
Twitter ä¸€å¤©å†…æ¶¨äº†ä¸€ç™¾å¤š foï¼Œè¿å¸¦ç€è¿™ä¸ªé¡¹ç›®ç›´æ¥æ”¶è· 100+ starsï¼GitHub Follower ä¹Ÿç ´ 200 äº†ğŸ˜„
çœŸçš„æœ‰ç‚¹å—å® è‹¥æƒŠå•Šï¼Œè¿˜å¥½è¿™é¡¹ç›®ä»£ç è´¨é‡ä¸èµ–ï¼Œä¸ç®—å¤ªä¸¢äººå“ˆå“ˆå“ˆã€‚
åŒæ—¶ Twitter ä¸Šä¹Ÿæœ‰äººæå‡ºå¯¹äº Apple Watchï¼Œå¯ä»¥ä½¿ç”¨ Short Cuts è¯»å–å¥åº· App çš„å¿ƒç‡æ•°æ®ï¼Œç„¶åè§¦å‘ GitHub Actions æ›´æ–° GitHub Profile READMEï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„æ€è·¯ã€‚</p>
<p>æœŸé—´è¿˜æœ‰äº†ä¸ªå°æ’æ›²ï¼Œè·‘æˆ‘è¿™ä¸ªå¿ƒè·³æœåŠ¡çš„æœºå™¨è¿˜è¢«äºº DDoS äº†ï¼Œæ”¶åˆ°è…¾è®¯äº‘çš„æŠ¥è­¦åæˆ‘èµ¶ç´§æ¢äº†æœºå™¨ + ä¸Š CloudFlare CDNï¼Œäººçº¢æ˜¯éå¤šå•Š&hellip;&hellip;</p>
<p>ä»Šåå¦‚æœè¿˜æœ‰ç©ºç»§ç»­æ”¹è¿›è¿™ä¸ªé¡¹ç›®çš„è¯ï¼Œæˆ‘å…¶å®æ˜¯æƒ³å†åŠ ä¸€ä¸ª Web ç•Œé¢è®©ç”¨æˆ·èƒ½æ‰‹åŠ¨é€‰æ‹©æƒ³è¦è¿æ¥çš„è®¾å¤‡çš„ã€‚åŒæ—¶èƒ½å¤Ÿå¯¹æ¯ä¸€æ¬¡çš„å¿ƒè·³æ•°æ®è¿›è¡Œä¿å­˜ã€‚æˆ‘å¤§æ¦‚ç®—äº†ä¸‹ï¼Œå¦‚æœä¸€æ¬¡å¿ƒè·³ä½¿ç”¨ 8 bits (0~255) æ¥è¡¨ç¤ºï¼Œç±»ä¼¼ Redis BitMap çš„æ–¹å¼ï¼Œä¸€ç§’ä¸€æ¬¡å¿ƒè·³è®°å½•ï¼Œä¸€å¹´ä¸‹æ¥ä¹Ÿå°± 8 * 3600 * 24 * 365 = 252,288,000 bitsï¼Œçº¦ç­‰äº 30 Mbã€‚å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼</p>